# Terraform Management Makefile
# å®‰å…¨ã§åŠ¹ç‡çš„ãªTerraformæ“ä½œã®ãŸã‚ã®ãƒ„ãƒ¼ãƒ«

.PHONY: help init plan apply destroy lock-status unlock cleanup validate fmt import-indexes list-indexes

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ˜ãƒ«ãƒ—
help:
	@echo "Terraform Management Commands:"
	@echo ""
	@echo "  make init          - TerraformåˆæœŸåŒ–"
	@echo "  make validate      - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼"
	@echo "  make fmt           - ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
	@echo "  make plan          - å®Ÿè¡Œãƒ—ãƒ©ãƒ³ã®ç¢ºèª"
	@echo "  make apply         - å®‰å…¨ãªå¤‰æ›´é©ç”¨"
	@echo "  make destroy       - ã‚¤ãƒ³ãƒ•ãƒ©å‰Šé™¤ï¼ˆè¦æ³¨æ„ï¼‰"
	@echo ""
	@echo "Lock Management:"
	@echo "  make lock-status   - ãƒ­ãƒƒã‚¯çŠ¶æ…‹ç¢ºèª"
	@echo "  make unlock ID=xxx - æ‰‹å‹•ãƒ­ãƒƒã‚¯è§£é™¤"
	@echo "  make cleanup       - å¤ã„ãƒ­ãƒƒã‚¯è‡ªå‹•å‰Šé™¤"
	@echo ""
	@echo "Firestore Management:"
	@echo "  make list-indexes  - æ—¢å­˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è¦§è¡¨ç¤º"
	@echo "  make import-indexes - æ—¢å­˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"
	@echo "  make check-indexes - ç°¡æ˜“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèªï¼ˆæ¨å¥¨ï¼‰"
	@echo ""
	@echo "Environment Variables:"
	@echo "  TF_VAR_FILE        - terraform.tfvars ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: terraform.tfvarsï¼‰"

# è¨­å®šå¤‰æ•°
TF_VAR_FILE ?= terraform.tfvars
SCRIPT_DIR = scripts

# TerraformåˆæœŸåŒ–
init:
	@echo "ğŸš€ TerraformåˆæœŸåŒ–ã‚’å®Ÿè¡Œä¸­..."
	terraform init
	@echo "âœ… åˆæœŸåŒ–å®Œäº†"

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
validate:
	@echo "ğŸ” Terraformè¨­å®šã‚’æ¤œè¨¼ä¸­..."
	terraform validate
	@echo "âœ… æ¤œè¨¼å®Œäº†"

# ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
fmt:
	@echo "ğŸ¨ Terraformã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
	terraform fmt -recursive
	@echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Œäº†"

# å®Ÿè¡Œãƒ—ãƒ©ãƒ³ç¢ºèª
plan:
	@echo "ğŸ“‹ Terraformå®Ÿè¡Œãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªä¸­..."
	@if [ ! -f "$(TF_VAR_FILE)" ]; then \
		echo "âŒ ã‚¨ãƒ©ãƒ¼: $(TF_VAR_FILE) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi
	terraform plan -var-file="$(TF_VAR_FILE)"

# å®‰å…¨ãªå¤‰æ›´é©ç”¨
apply:
	@echo "ğŸ”„ å®‰å…¨ãªTerraformé©ç”¨ã‚’å®Ÿè¡Œä¸­..."
	@./$(SCRIPT_DIR)/tf-lock-check.sh apply

# æ‰‹å‹•ãƒ—ãƒ©ãƒ³å¾Œé©ç”¨ï¼ˆé€šå¸¸ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰
apply-manual:
	@echo "ğŸ“‹ å®Ÿè¡Œãƒ—ãƒ©ãƒ³ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é©ç”¨..."
	@if [ ! -f "$(TF_VAR_FILE)" ]; then \
		echo "âŒ ã‚¨ãƒ©ãƒ¼: $(TF_VAR_FILE) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		exit 1; \
	fi
	terraform plan -var-file="$(TF_VAR_FILE)"
	@echo ""
	@read -p "ã“ã®å¤‰æ›´ã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		terraform apply -var-file="$(TF_VAR_FILE)"; \
	else \
		echo "é©ç”¨ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
	fi

# ã‚¤ãƒ³ãƒ•ãƒ©å‰Šé™¤ï¼ˆå±é™ºï¼‰
destroy:
	@echo "âš ï¸  è­¦å‘Š: ã‚¤ãƒ³ãƒ•ãƒ©ã‚’å‰Šé™¤ã—ã¾ã™"
	@echo "ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼"
	@read -p "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (DELETE): " confirm; \
	if [ "$$confirm" = "DELETE" ]; then \
		terraform destroy -var-file="$(TF_VAR_FILE)"; \
	else \
		echo "å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
	fi

# ãƒ­ãƒƒã‚¯ç®¡ç†
lock-status:
	@echo "ğŸ”’ Terraformãƒ­ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¢ºèªä¸­..."
	@./$(SCRIPT_DIR)/tf-lock-check.sh status

unlock:
	@if [ -z "$(ID)" ]; then \
		echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ­ãƒƒã‚¯IDãŒå¿…è¦ã§ã™"; \
		echo "ä½¿ç”¨æ–¹æ³•: make unlock ID=1234567890"; \
		exit 1; \
	fi
	@echo "ğŸ”“ ãƒ­ãƒƒã‚¯ $(ID) ã‚’è§£é™¤ä¸­..."
	@./$(SCRIPT_DIR)/tf-lock-check.sh unlock $(ID)

cleanup:
	@echo "ğŸ§¹ å¤ã„ãƒ­ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­..."
	@./$(SCRIPT_DIR)/tf-lock-check.sh cleanup

# é–‹ç™ºç”¨ã‚³ãƒãƒ³ãƒ‰
dev-setup: init validate fmt
	@echo "ğŸ› ï¸  é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†"

# æœ¬ç•ªé©ç”¨å‰ãƒã‚§ãƒƒã‚¯
pre-production: validate fmt plan
	@echo "ğŸš€ æœ¬ç•ªé©ç”¨å‰ãƒã‚§ãƒƒã‚¯å®Œäº†"
	@echo "å•é¡Œãªã‘ã‚Œã° 'make apply' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"

# ç·Šæ€¥æ™‚å¾©æ—§
emergency-unlock:
	@echo "ğŸš¨ ç·Šæ€¥ãƒ­ãƒƒã‚¯è§£é™¤ãƒ¢ãƒ¼ãƒ‰"
	@echo "ç¾åœ¨ã®ãƒ­ãƒƒã‚¯çŠ¶æ³ï¼š"
	@./$(SCRIPT_DIR)/tf-lock-check.sh status || true
	@echo ""
	@read -p "ã™ã¹ã¦ã®ãƒ­ãƒƒã‚¯ã‚’å¼·åˆ¶è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ (EMERGENCY): " confirm; \
	if [ "$$confirm" = "EMERGENCY" ]; then \
		./$(SCRIPT_DIR)/tf-lock-check.sh cleanup; \
		echo "ç·Šæ€¥è§£é™¤å®Œäº†"; \
	else \
		echo "ç·Šæ€¥è§£é™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ"; \
	fi

# Firestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç®¡ç†
list-indexes:
	@echo "ğŸ“‹ Firestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸€è¦§ã‚’è¡¨ç¤ºä¸­..."
	@./$(SCRIPT_DIR)/list-firestore-indexes.sh

import-indexes:
	@echo "ğŸ”„ æ—¢å­˜Firestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­..."
	@./$(SCRIPT_DIR)/import-firestore-indexes.sh

check-indexes:
	@echo "ğŸ” Firestoreã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç°¡æ˜“ç¢ºèª..."
	@./$(SCRIPT_DIR)/simple-firestore-import.sh