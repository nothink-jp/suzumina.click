# Next.jsアプリケーション用のCloud Buildファイル
steps:
  # ワーキングディレクトリの確認
  - name: 'bash'
    args: ['echo', 'Working directory: /workspace, deploying branch: ${_BRANCH} to ${_DEPLOY_ENV} environment, app path: ${_APP_PATH}']
  
  # pnpmのインストール
  - name: 'gcr.io/cloud-builders/npm'
    args: ['install', '-g', 'pnpm']
    
  # 依存関係のインストール
  - name: 'gcr.io/cloud-builders/npm'
    entrypoint: 'pnpm'
    args: ['install', '--frozen-lockfile']
  
  # Next.jsアプリケーションのビルド
  - name: 'gcr.io/cloud-builders/npm'
    entrypoint: 'pnpm'
    args: ['--filter', '@suzumina.click/web', 'build']
    env:
      - 'NEXT_PUBLIC_DEPLOY_ENV=${_DEPLOY_ENV}'
  
  # Dockerイメージのビルド
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/suzumina-click-nextjs-app:$COMMIT_SHA', '-t', 'gcr.io/$PROJECT_ID/suzumina-click-nextjs-app:latest', './${_APP_PATH}']
  
  # イメージをContainer Registryにプッシュ
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/suzumina-click-nextjs-app:$COMMIT_SHA']
  
  # Cloud Runへのデプロイ
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: [
      'run', 'deploy', 'suzumina-click-nextjs-app',
      '--image', 'gcr.io/$PROJECT_ID/suzumina-click-nextjs-app:$COMMIT_SHA',
      '--region', 'asia-northeast1',
      '--platform', 'managed',
      '--allow-unauthenticated'
    ]

  # デプロイ完了通知
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'gcloud'
    args: ['pubsub', 'topics', 'publish', '${_NOTIFICATION_TOPIC}', '--message', 'Deploy completed successfully! Environment: ${_DEPLOY_ENV}, Branch: ${_BRANCH}, Image: gcr.io/$PROJECT_ID/suzumina-click-nextjs-app:$COMMIT_SHA']

# ビルドされたイメージを保存
images:
  - 'gcr.io/$PROJECT_ID/suzumina-click-nextjs-app:$COMMIT_SHA'
  - 'gcr.io/$PROJECT_ID/suzumina-click-nextjs-app:latest'

# 代入変数のデフォルト値
substitutions:
  _DEPLOY_ENV: 'evaluation'  # デプロイ環境: 'evaluation' または 'production'
  _BRANCH: 'unknown'         # デプロイ元のブランチ名
  _NOTIFICATION_TOPIC: 'cloud-builds'  # 通知用Pub/Subトピック
  _CONTEXT_PATH: '.'         # プロジェクトのルートパス
  _APP_PATH: 'apps/web'      # アプリケーションのパス

# タイムアウト設定 (30分)
timeout: 1800s