name: 'Terraform Preview Deploy'

on:
  pull_request:
    branches:
      - main
    paths:
      - 'functions/**'
      - 'terraform/**'
      - '.github/workflows/terraform-*'

jobs:
  terraform-preview:
    name: 'Terraform Preview'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    # プルリクエストの番号を環境変数として設定
    env:
      PR_NUMBER: ${{ github.event.number }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Functions Install Dependencies
        run: pnpm install
        working-directory: ./functions
      
      - name: Functions Build
        run: pnpm run build
        working-directory: ./functions

      # Terraformをセットアップ
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      # GCPの認証を設定
      - name: 'Authenticate to Google Cloud'
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          export_environment_variables: true

      # Terraformの初期化
      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      # プレビュー環境用のワークスペース準備
      - name: Terraform Workspace
        run: |
          terraform workspace select preview || terraform workspace new preview
        working-directory: ./terraform

      # Terraformプラン（変更内容の確認）
      - name: Terraform Plan
        run: |
          terraform plan -var-file="terraform.tfvars" -var="environment=preview" -no-color -input=false
        working-directory: ./terraform
        env:
          TF_VAR_youtube_api_key: ${{ secrets.YOUTUBE_API_KEY }}

      # Terraformの適用（プレビュー環境へのデプロイ）
      - name: Terraform Apply
        run: |
          terraform apply -var-file="terraform.tfvars" -var="environment=preview" -auto-approve -input=false
        working-directory: ./terraform
        env:
          TF_VAR_youtube_api_key: ${{ secrets.YOUTUBE_API_KEY }}

      # デプロイ結果のコメント
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const functionUrls = {
              discordAuthCallback: `https://preview-discordAuthCallback-xxxxxxxx-an.a.run.app`, 
              fetchYouTubeVideos: `Pub/Subトリガー（URLはありません）`
            };
            
            // コメント本文を作成
            const comment = `## 🚀 プレビュー環境デプロイ完了
            
            **デプロイされたCloud Functions:**
            - discordAuthCallback: ${functionUrls.discordAuthCallback}
            - fetchYouTubeVideos: ${functionUrls.fetchYouTubeVideos}
            
            プレビューURLは固定値の例です。実際のURLはデプロイ後に生成されます。`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });