name: 'Terraform Preview Deploy'

on:
  pull_request:
    branches:
      - main
    paths:
      - 'functions/**'
      - 'terraform/**'
      - '.github/workflows/terraform-*'

jobs:
  terraform-preview:
    name: 'Terraform Preview'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    # ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç•ªå·ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
    env:
      PR_NUMBER: ${{ github.event.number }}
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: Functions Install Dependencies
        run: pnpm install
        working-directory: ./functions
      
      - name: Functions Build
        run: pnpm run build
        working-directory: ./functions

      # Terraformã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0

      # GCPã®èªè¨¼ã‚’è¨­å®š
      - name: 'Authenticate to Google Cloud'
        id: auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          export_environment_variables: true

      # Terraformã®åˆæœŸåŒ–
      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform

      # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒç”¨ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æº–å‚™
      - name: Terraform Workspace
        run: |
          terraform workspace select preview || terraform workspace new preview
        working-directory: ./terraform

      # Terraformãƒ—ãƒ©ãƒ³ï¼ˆå¤‰æ›´å†…å®¹ã®ç¢ºèªï¼‰
      - name: Terraform Plan
        run: |
          terraform plan -var-file="terraform.tfvars" -var="environment=preview" -no-color -input=false
        working-directory: ./terraform
        env:
          TF_VAR_youtube_api_key: ${{ secrets.YOUTUBE_API_KEY }}

      # Terraformã®é©ç”¨ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
      - name: Terraform Apply
        run: |
          terraform apply -var-file="terraform.tfvars" -var="environment=preview" -auto-approve -input=false
        working-directory: ./terraform
        env:
          TF_VAR_youtube_api_key: ${{ secrets.YOUTUBE_API_KEY }}

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®ã‚³ãƒ¡ãƒ³ãƒˆ
      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const functionUrls = {
              discordAuthCallback: `https://preview-discordAuthCallback-xxxxxxxx-an.a.run.app`, 
              fetchYouTubeVideos: `Pub/Subãƒˆãƒªã‚¬ãƒ¼ï¼ˆURLã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰`
            };
            
            // ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ä½œæˆ
            const comment = `## ğŸš€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
            
            **ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸCloud Functions:**
            - discordAuthCallback: ${functionUrls.discordAuthCallback}
            - fetchYouTubeVideos: ${functionUrls.fetchYouTubeVideos}
            
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã¯å›ºå®šå€¤ã®ä¾‹ã§ã™ã€‚å®Ÿéš›ã®URLã¯ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });