# =============================================================================
# Audio Processor Docker Image CI/CD
# =============================================================================
# Audio ProcessorÁî®Docker„Ç§„É°„Éº„Ç∏„ÅÆËá™Âãï„Éì„É´„Éâ„Éª„Éá„Éó„É≠„Ç§„ÉØ„Éº„ÇØ„Éï„É≠„Éº
# apps/audio-processor/ ÈÖç‰∏ã„ÅÆÂ§âÊõ¥ÊôÇ„Å´„Éà„É™„Ç¨„Éº„Åï„Çå„Çã

name: Deploy Audio Processor

on:
  push:
    branches:
      - main
    paths:
      - 'apps/audio-processor/**'
      - '.github/workflows/deploy-audio-processor.yml'
  
  pull_request:
    branches:
      - main
    paths:
      - 'apps/audio-processor/**'
      - '.github/workflows/deploy-audio-processor.yml'
  
  # ÊâãÂãïÂÆüË°åÂèØËÉΩ
  workflow_dispatch:
    inputs:
      deploy_to_production:
        description: 'Deploy to production (main branch only)'
        required: false
        default: 'false'
        type: boolean

env:
  # Google CloudË®≠ÂÆö
  PROJECT_ID: suzumina-click-firebase
  GAR_LOCATION: us-central1
  GAR_REPOSITORY: suzumina-click
  SERVICE_NAME: audio-processor
  REGION: us-central1
  
  # Docker „Ç§„É°„Éº„Ç∏Ë®≠ÂÆö
  IMAGE_NAME: audio-processor
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # =============================================================================
  # Docker „Ç§„É°„Éº„Ç∏„Éì„É´„Éâ„Éª„Éó„ÉÉ„Ç∑„É•
  # =============================================================================
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    # Ê®©ÈôêË®≠ÂÆö
    permissions:
      contents: read
      id-token: write
    
    outputs:
      image-url: ${{ steps.build.outputs.image-url }}
      image-digest: ${{ steps.build.outputs.image-digest }}
    
    steps:
      # =============================================================================
      # 1. „É™„Éù„Ç∏„Éà„É™„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      # =============================================================================
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # =============================================================================
      # 2. Google CloudË™çË®º
      # =============================================================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/528184455047/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-sa@suzumina-click-firebase.iam.gserviceaccount.com
      
      # =============================================================================
      # 3. Google Cloud SDK „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      # =============================================================================
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
      
      # =============================================================================
      # 4. DockerË™çË®ºË®≠ÂÆö
      # =============================================================================
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev
      
      # =============================================================================
      # 5. Docker„Ç§„É°„Éº„Ç∏„ÅÆ„Éì„É´„Éâ„Éª„Éó„ÉÉ„Ç∑„É•
      # =============================================================================
      - name: Build and Push Docker Image
        id: build
        working-directory: ./apps/audio-processor
        run: |
          # „Ç§„É°„Éº„Ç∏Âêç„ÅÆÂÆåÂÖ®„Éë„Çπ
          IMAGE_URL="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.GAR_REPOSITORY }}/${{ env.IMAGE_NAME }}"
          
          # „Çø„Ç∞Ë®≠ÂÆö
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAGS="${IMAGE_URL}:latest,${IMAGE_URL}:${{ env.IMAGE_TAG }}"
          else
            TAGS="${IMAGE_URL}:pr-${{ github.event.number }},${IMAGE_URL}:${{ env.IMAGE_TAG }}"
          fi
          
          echo "Building Docker image..."
          echo "Image URL: ${IMAGE_URL}"
          echo "Tags: ${TAGS}"
          
          # Docker„Ç§„É°„Éº„Ç∏„Éì„É´„Éâ
          docker build \
            --tag "${IMAGE_URL}:latest" \
            --tag "${IMAGE_URL}:${{ env.IMAGE_TAG }}" \
            --platform linux/amd64 \
            --build-arg BUILDKIT_INLINE_CACHE=1 \
            .
          
          echo "Pushing Docker image..."
          
          # „Éó„ÉÉ„Ç∑„É•
          docker push "${IMAGE_URL}:latest"
          docker push "${IMAGE_URL}:${{ env.IMAGE_TAG }}"
          
          # „Ç§„É°„Éº„Ç∏„ÉÄ„Ç§„Ç∏„Çß„Çπ„ÉàÂèñÂæó
          IMAGE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${IMAGE_URL}:latest" | cut -d'@' -f2)
          
          # Âá∫ÂäõË®≠ÂÆö
          echo "image-url=${IMAGE_URL}:latest" >> $GITHUB_OUTPUT
          echo "image-digest=${IMAGE_DIGEST}" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Docker image built and pushed successfully"
          echo "üì¶ Image: ${IMAGE_URL}:latest"
          echo "üè∑Ô∏è  Tag: ${{ env.IMAGE_TAG }}"
          echo "üîç Digest: ${IMAGE_DIGEST}"
      
      # =============================================================================
      # 6. „Ç§„É°„Éº„Ç∏ËÑÜÂº±ÊÄß„Çπ„Ç≠„É£„É≥ÔºàoptionalÔºâ
      # =============================================================================
      - name: Scan Docker Image for Vulnerabilities
        continue-on-error: true
        run: |
          IMAGE_URL="${{ steps.build.outputs.image-url }}"
          echo "Scanning image for vulnerabilities: ${IMAGE_URL}"
          
          # Artifact Registry„Åß„ÅÆËÑÜÂº±ÊÄß„Çπ„Ç≠„É£„É≥ÂÆüË°å
          gcloud artifacts docker images scan "${IMAGE_URL}" \
            --location=${{ env.GAR_LOCATION }} \
            --quiet
          
          echo "‚úÖ Vulnerability scan completed"

  # =============================================================================
  # Cloud Run Jobs „Éá„Éó„É≠„Ç§ÔºàÊú¨Áï™Áí∞Â¢É„ÅÆ„ÅøÔºâ
  # =============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || inputs.deploy_to_production == 'true')
    
    # Ê®©ÈôêË®≠ÂÆö
    permissions:
      contents: read
      id-token: write
    
    environment:
      name: production
      url: https://console.cloud.google.com/run/jobs/details/${{ env.REGION }}/${{ env.SERVICE_NAME }}
    
    steps:
      # =============================================================================
      # 1. „É™„Éù„Ç∏„Éà„É™„ÉÅ„Çß„ÉÉ„ÇØ„Ç¢„Ç¶„Éà
      # =============================================================================
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # =============================================================================
      # 2. Google CloudË™çË®º
      # =============================================================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          workload_identity_provider: projects/528184455047/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-sa@suzumina-click-firebase.iam.gserviceaccount.com
      
      # =============================================================================
      # 3. Google Cloud SDK „Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
      # =============================================================================
      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: 'latest'
      
      # =============================================================================
      # 4. Cloud Run JobsÊõ¥Êñ∞
      # =============================================================================
      - name: Update Cloud Run Job
        run: |
          IMAGE_URL="${{ needs.build-and-push.outputs.image-url }}"
          JOB_NAME="${{ env.SERVICE_NAME }}"
          
          echo "Updating Cloud Run Job: ${JOB_NAME}"
          echo "New Image: ${IMAGE_URL}"
          
          # Cloud Run Jobs„ÅÆÂ≠òÂú®Á¢∫Ë™ç
          if gcloud run jobs describe "${JOB_NAME}" --region="${{ env.REGION }}" --quiet >/dev/null 2>&1; then
            echo "Updating existing Cloud Run Job..."
            
            # Êó¢Â≠ò„ÅÆCloud Run JobsÊõ¥Êñ∞
            gcloud run jobs replace <(
              gcloud run jobs describe "${JOB_NAME}" \
                --region="${{ env.REGION }}" \
                --format="export" | \
              yq eval '.spec.template.spec.template.spec.containers[0].image = "'${IMAGE_URL}'"' -
            ) --region="${{ env.REGION }}"
            
          else
            echo "Creating new Cloud Run Job..."
            
            # Êñ∞Ë¶è‰ΩúÊàêÔºàTerraform„Åß‰ΩúÊàê„Åï„Çå„Å¶„ÅÑ„ÇãÊÉ≥ÂÆö„Å†„Åå„ÄÅ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            gcloud run jobs create "${JOB_NAME}" \
              --image="${IMAGE_URL}" \
              --region="${{ env.REGION }}" \
              --memory="16Gi" \
              --cpu="4" \
              --max-retries=1 \
              --parallelism=1 \
              --task-timeout="3600" \
              --service-account="audio-processor@${{ env.PROJECT_ID }}.iam.gserviceaccount.com" \
              --set-env-vars="GOOGLE_CLOUD_PROJECT=${{ env.PROJECT_ID }}" \
              --set-env-vars="AUDIO_BUCKET_NAME=${{ env.PROJECT_ID }}-audio-files" \
              --set-env-vars="FIRESTORE_DATABASE=(default)" \
              --set-env-vars="CLOUD_RUN_JOB=true" \
              --set-env-vars="LOG_LEVEL=INFO" \
              --set-env-vars="MAX_AUDIO_BUTTONS=20" \
              --set-env-vars="OPUS_BITRATE=128k" \
              --set-env-vars="AAC_BITRATE=128k"
          fi
          
          echo "‚úÖ Cloud Run Job updated successfully"
          
          # „Éá„Éó„É≠„Ç§ÊÉÖÂ†±Âá∫Âäõ
          echo "üì¶ Service: ${JOB_NAME}"
          echo "üñºÔ∏è  Image: ${IMAGE_URL}"
          echo "üåç Region: ${{ env.REGION }}"
          echo "üîó Console: https://console.cloud.google.com/run/jobs/details/${{ env.REGION }}/${JOB_NAME}"
      
      # =============================================================================
      # 5. „Éá„Éó„É≠„Ç§ÁµêÊûúÈÄöÁü•
      # =============================================================================
      - name: Deployment Summary
        run: |
          echo "## üéâ Audio Processor Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ env.SERVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ needs.build-and-push.outputs.image-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Run Job Console](https://console.cloud.google.com/run/jobs/details/${{ env.REGION }}/${{ env.SERVICE_NAME }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Cloud Logging](https://console.cloud.google.com/logs/query;query=resource.type%3D%22cloud_run_job%22%0Aresource.labels.job_name%3D%22${{ env.SERVICE_NAME }}%22)" >> $GITHUB_STEP_SUMMARY
          echo "- [Artifact Registry](https://console.cloud.google.com/artifacts/docker/${{ env.PROJECT_ID }}/${{ env.GAR_LOCATION }}/${{ env.GAR_REPOSITORY }})" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # „Éó„É¨„Éì„É•„ÉºÁí∞Â¢É„Éá„Éó„É≠„Ç§ÔºàPRÁî®Ôºâ
  # =============================================================================
  deploy-preview:
    name: Deploy to Preview
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'pull_request'
    
    # Ê®©ÈôêË®≠ÂÆö
    permissions:
      contents: read
      id-token: write
      pull-requests: write
    
    environment:
      name: preview
    
    steps:
      # „Éó„É¨„Éì„É•„ÉºÁí∞Â¢ÉÁî®„ÅÆÁ∞°Êòì„ÉÅ„Çß„ÉÉ„ÇØ
      - name: Preview Deployment Check
        run: |
          echo "## üîç Audio Processor Preview Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ needs.build-and-push.outputs.image-url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PR**: #${{ github.event.number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚ö†Ô∏è Note" >> $GITHUB_STEP_SUMMARY
          echo "This is a preview build. The image has been built and pushed to the registry," >> $GITHUB_STEP_SUMMARY
          echo "but it will only be deployed to production when merged to main branch." >> $GITHUB_STEP_SUMMARY
          
          echo "‚úÖ Preview build completed successfully"