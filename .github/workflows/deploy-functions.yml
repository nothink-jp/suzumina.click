name: Deploy Cloud Functions

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared-types
        run: pnpm --filter=@suzumina.click/shared-types build

      - name: Build functions
        run: pnpm --filter=@suzumina.click/functions build

      - name: Run tests
        run: pnpm --filter=@suzumina.click/functions test

      - name: Authenticate to GCP
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'cloud-functions-deployer-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create deployment bundle
        run: |
          # ä¸€æ™‚çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p ./deployment-temp
          
          # shared-typesã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–
          cd packages/shared-types
          pnpm pack --pack-destination ../../deployment-temp
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç¢ºå®Ÿã«å–å¾—
          cd ../../deployment-temp
          SHARED_TYPES_FILE=$(ls suzumina.click-shared-types-*.tgz | head -n1)
          echo "Found shared-types package: $SHARED_TYPES_FILE"
          
          # functionsã®ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã¨package.jsonã‚’ã‚³ãƒ”ãƒ¼
          cp -r ../apps/functions/lib ./
          cp ../apps/functions/package.json ./
          
          # Node.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã§package.jsonã‚’å®‰å…¨ã«å¤‰æ›´
          SHARED_TYPES_FILE="$SHARED_TYPES_FILE" node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            
            // workspaceä¾å­˜é–¢ä¿‚ã‚’å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›´
            if (pkg.dependencies && pkg.dependencies['@suzumina.click/shared-types']) {
              pkg.dependencies['@suzumina.click/shared-types'] = 'file:./' + process.env.SHARED_TYPES_FILE;
            }
            
            // é–‹ç™ºç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤
            if (pkg.scripts) {
              delete pkg.scripts.build;
              delete pkg.scripts['build:watch'];
              delete pkg.scripts.lint;
              delete pkg.scripts.format;
              delete pkg.scripts.check;
              delete pkg.scripts.test;
              delete pkg.scripts['test:watch'];
              delete pkg.scripts['test:coverage'];
            }
            
            // devDependenciesã‚’å‰Šé™¤
            delete pkg.devDependencies;
            
            // Cloud Functions v2ã§ã¯Functions FrameworkãŒè‡ªå‹•çš„ã«èµ·å‹•ã™ã‚‹ãŸã‚ã€
            // startã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä¸è¦ã€‚mainã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®ã¿è¨­å®š
            pkg.main = 'lib/index.js';
            
            // enginesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ç¢ºå®Ÿã«è¨­å®š
            if (!pkg.engines) {
              pkg.engines = {};
            }
            pkg.engines.node = '22';
            
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          
          # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆproductionç”¨ï¼‰
          pnpm install --prod --frozen-lockfile
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
          tar -czf ../functions-deployment.tar.gz *
          cd ..
          
          echo "Deployment bundle created: functions-deployment.tar.gz"

      - name: Upload to Cloud Storage
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®Cloud Storageãƒã‚±ãƒƒãƒˆåã‚’è¨­å®š
          BUCKET_NAME="${{ secrets.GCP_PROJECT_ID }}-functions-deployment"
          
          # ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if ! gsutil ls gs://$BUCKET_NAME/ &>/dev/null; then
            echo "âŒ Error: Deployment bucket does not exist: gs://$BUCKET_NAME"
            echo "Please create the bucket first using one of these methods:"
            echo ""
            echo "1. Using gcloud CLI:"
            echo "   gcloud storage buckets create gs://$BUCKET_NAME --location=asia-northeast1 --project=${{ secrets.GCP_PROJECT_ID }}"
            echo ""
            echo "2. Using Terraform (recommended):"
            echo "   Add the following resource to your terraform configuration:"
            echo "   resource \"google_storage_bucket\" \"functions_deployment\" {"
            echo "     name     = \"$BUCKET_NAME\""
            echo "     location = \"asia-northeast1\""
            echo "   }"
            echo ""
            echo "3. Using Google Cloud Console:"
            echo "   Visit https://console.cloud.google.com/storage and create a bucket named '$BUCKET_NAME'"
            exit 1
          else
            echo "âœ… Deployment bucket exists: $BUCKET_NAME"
          fi
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          ARCHIVE_NAME="functions-${TIMESTAMP}.tar.gz"
          
          echo "ðŸ“¤ Uploading deployment archive..."
          gsutil cp functions-deployment.tar.gz gs://$BUCKET_NAME/$ARCHIVE_NAME
          echo "âœ… Uploaded: gs://$BUCKET_NAME/$ARCHIVE_NAME"
          
          # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ä¿å­˜
          echo "DEPLOYMENT_SOURCE=gs://$BUCKET_NAME/$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "BUCKET_NAME=$BUCKET_NAME" >> $GITHUB_ENV

      - name: Deploy fetchYouTubeVideos function
        run: |
          gcloud functions deploy fetchYouTubeVideos \
            --source ${{ env.DEPLOYMENT_SOURCE }} \
            --runtime nodejs22 \
            --entry-point fetchYouTubeVideos \
            --trigger-topic youtube-video-fetch-trigger \
            --region asia-northeast1 \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --set-env-vars NODE_ENV=production \
            --memory 512MB \
            --timeout 540s \
            --max-instances 10 \
            --quiet

      - name: Deploy fetchDLsiteWorks function
        run: |
          gcloud functions deploy fetchDLsiteWorks \
            --source ${{ env.DEPLOYMENT_SOURCE }} \
            --runtime nodejs22 \
            --entry-point fetchDLsiteWorks \
            --trigger-topic dlsite-works-fetch-trigger \
            --region asia-northeast1 \
            --project ${{ secrets.GCP_PROJECT_ID }} \
            --set-env-vars NODE_ENV=production \
            --memory 512MB \
            --timeout 540s \
            --max-instances 10 \
            --quiet

      - name: Cleanup deployment artifacts
        if: always()
        run: |
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -rf ./deployment-temp
          rm -f functions-deployment.tar.gz
          
          # å¤ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆæœ€æ–°5å€‹ã‚’ä¿æŒï¼‰
          if [ ! -z "${{ env.BUCKET_NAME }}" ]; then
            echo "Cleaning up old deployment files..."
            gsutil ls gs://${{ env.BUCKET_NAME }}/functions-*.tar.gz | \
              sort -r | \
              tail -n +6 | \
              xargs -r gsutil rm || echo "No old files to clean up"
          fi

      - name: Deploy status summary
        run: |
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸé–¢æ•°" >> $GITHUB_STEP_SUMMARY
          echo "- **fetchYouTubeVideos**: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: \`youtube-video-fetch-trigger\` (Pub/Sub)" >> $GITHUB_STEP_SUMMARY
          echo "- **fetchDLsiteWorks**: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: \`dlsite-works-fetch-trigger\` (Pub/Sub)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ è¨­å®šæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: \`${{ secrets.GCP_PROJECT_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: \`asia-northeast1\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ **: \`nodejs22\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ¡ãƒ¢ãƒª**: \`512MB\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: \`540ç§’\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‡ãƒ—ãƒ­ã‚¤ã‚½ãƒ¼ã‚¹**: \`${{ env.DEPLOYMENT_SOURCE }}\`" >> $GITHUB_STEP_SUMMARY