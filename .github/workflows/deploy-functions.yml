name: Deploy Cloud Functions

on:
  push:
    branches:
      - main
    paths:
      - 'apps/functions/**'
      - 'packages/shared-types/**'
      - '.github/workflows/deploy-functions.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared-types
        run: pnpm --filter=@suzumina.click/shared-types build

      - name: Build functions
        run: pnpm --filter=@suzumina.click/functions build

      - name: Run tests
        run: pnpm --filter=@suzumina.click/functions test

      - name: Authenticate to GCP
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'cloud-functions-deployer-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Create deployment bundle
        run: |
          # ä¸€æ™‚çš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
          mkdir -p ./deployment-temp
          
          # shared-typesã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åŒ–
          cd packages/shared-types
          pnpm pack --pack-destination ../../deployment-temp
          
          # ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç¢ºå®Ÿã«å–å¾—
          cd ../../deployment-temp
          SHARED_TYPES_FILE=$(ls suzumina.click-shared-types-*.tgz | head -n1)
          echo "Found shared-types package: $SHARED_TYPES_FILE"
          
          # functionsã®ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã¨package.jsonã‚’ã‚³ãƒ”ãƒ¼
          cp -r ../apps/functions/lib ./
          cp ../apps/functions/package.json ./
          
          # Node.jsã‚¹ã‚¯ãƒªãƒ—ãƒˆã§package.jsonã‚’å®‰å…¨ã«å¤‰æ›´
          SHARED_TYPES_FILE="$SHARED_TYPES_FILE" node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            
            // workspaceä¾å­˜é–¢ä¿‚ã‚’å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«å¤‰æ›´
            if (pkg.dependencies && pkg.dependencies['@suzumina.click/shared-types']) {
              pkg.dependencies['@suzumina.click/shared-types'] = 'file:./' + process.env.SHARED_TYPES_FILE;
            }
            
            // é–‹ç™ºç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‰Šé™¤
            if (pkg.scripts) {
              delete pkg.scripts.build;
              delete pkg.scripts['build:watch'];
              delete pkg.scripts.lint;
              delete pkg.scripts.format;
              delete pkg.scripts.check;
              delete pkg.scripts.test;
              delete pkg.scripts['test:watch'];
              delete pkg.scripts['test:coverage'];
            }
            
            // devDependenciesã‚’å‰Šé™¤
            delete pkg.devDependencies;
            
            // Cloud Functions v2ã§ã¯Functions FrameworkãŒè‡ªå‹•çš„ã«èµ·å‹•ã™ã‚‹ãŸã‚ã€
            // startã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä¸è¦ã€‚mainã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã®ã¿è¨­å®š
            pkg.main = 'lib/index.js';
            
            // enginesãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ç¢ºå®Ÿã«è¨­å®š
            if (!pkg.engines) {
              pkg.engines = {};
            }
            pkg.engines.node = '22';
            
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "
          
          # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆproductionç”¨ï¼‰
          pnpm install --prod --frozen-lockfile
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®zipãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆCloud Functionsã¯zipã‚’è¦æ±‚ï¼‰
          zip -r ../functions-deployment.zip *
          cd ..
          
          echo "Deployment bundle created: functions-deployment.zip"

      - name: Upload to Cloud Storage
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®Cloud Storageãƒã‚±ãƒƒãƒˆåã‚’è¨­å®š
          BUCKET_NAME="${{ secrets.GCP_PROJECT_ID }}-functions-deployment"
          
          # ãƒã‚±ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if ! gsutil ls gs://$BUCKET_NAME/ &>/dev/null; then
            echo "âŒ Error: Deployment bucket does not exist: gs://$BUCKET_NAME"
            echo "Please create the bucket first using one of these methods:"
            echo ""
            echo "1. Using gcloud CLI:"
            echo "   gcloud storage buckets create gs://$BUCKET_NAME --location=asia-northeast1 --project=${{ secrets.GCP_PROJECT_ID }}"
            echo ""
            echo "2. Using Terraform (recommended):"
            echo "   Add the following resource to your terraform configuration:"
            echo "   resource \"google_storage_bucket\" \"functions_deployment\" {"
            echo "     name     = \"$BUCKET_NAME\""
            echo "     location = \"asia-northeast1\""
            echo "   }"
            echo ""
            echo "3. Using Google Cloud Console:"
            echo "   Visit https://console.cloud.google.com/storage and create a bucket named '$BUCKET_NAME'"
            exit 1
          else
            echo "âœ… Deployment bucket exists: $BUCKET_NAME"
          fi
          
          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          ARCHIVE_NAME="functions-${TIMESTAMP}.zip"
          
          echo "ðŸ“¤ Uploading deployment archive..."
          gsutil cp functions-deployment.zip gs://$BUCKET_NAME/$ARCHIVE_NAME
          echo "âœ… Uploaded: gs://$BUCKET_NAME/$ARCHIVE_NAME"
          
          # ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦ä¿å­˜
          echo "DEPLOYMENT_SOURCE=gs://$BUCKET_NAME/$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "BUCKET_NAME=$BUCKET_NAME" >> $GITHUB_ENV

      - name: Check and wait for pending operations
        run: |
          echo "ðŸ” Checking for pending Cloud Functions operations..."
          
          # é€²è¡Œä¸­ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          PENDING_OPS=$(gcloud functions operations list \
            --region=asia-northeast1 \
            --project=${{ secrets.GCP_PROJECT_ID }} \
            --filter="done=false" \
            --format="value(name)" || echo "")
          
          if [ ! -z "$PENDING_OPS" ]; then
            echo "â³ Found pending operations, waiting for completion..."
            echo "$PENDING_OPS"
            
            # æœ€å¤§5åˆ†é–“å¾…æ©Ÿ
            for i in {1..30}; do
              sleep 10
              PENDING_OPS=$(gcloud functions operations list \
                --region=asia-northeast1 \
                --project=${{ secrets.GCP_PROJECT_ID }} \
                --filter="done=false" \
                --format="value(name)" || echo "")
              
              if [ -z "$PENDING_OPS" ]; then
                echo "âœ… All pending operations completed"
                break
              fi
              
              echo "Still waiting... ($i/30)"
              
              if [ $i -eq 30 ]; then
                echo "âš ï¸ Warning: Some operations are still pending after 5 minutes"
                echo "Continuing with deployment..."
              fi
            done
          else
            echo "âœ… No pending operations found"
          fi

      - name: Deploy fetchYouTubeVideos function
        run: |
          echo "ðŸš€ Deploying fetchYouTubeVideos function..."
          
          # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãã§ãƒ‡ãƒ—ãƒ­ã‚¤
          for attempt in 1 2 3; do
            echo "Attempt $attempt/3..."
            
            if gcloud functions deploy fetchYouTubeVideos \
              --source ${{ env.DEPLOYMENT_SOURCE }} \
              --runtime nodejs22 \
              --entry-point fetchYouTubeVideos \
              --trigger-topic youtube-video-fetch-trigger \
              --region asia-northeast1 \
              --project ${{ secrets.GCP_PROJECT_ID }} \
              --set-env-vars NODE_ENV=production,FUNCTION_SIGNATURE_TYPE=cloudevent,FUNCTION_TARGET=fetchYouTubeVideos \
              --memory 512MB \
              --timeout 540s \
              --max-instances 10 \
              --quiet; then
              echo "âœ… fetchYouTubeVideos deployed successfully"
              break
            else
              echo "âŒ Deploy failed on attempt $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ðŸš¨ All retry attempts failed"
                exit 1
              fi
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
            fi
          done

      - name: Deploy fetchDLsiteWorks function
        run: |
          echo "ðŸš€ Deploying fetchDLsiteWorks function..."
          
          # ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãã§ãƒ‡ãƒ—ãƒ­ã‚¤
          for attempt in 1 2 3; do
            echo "Attempt $attempt/3..."
            
            if gcloud functions deploy fetchDLsiteWorks \
              --source ${{ env.DEPLOYMENT_SOURCE }} \
              --runtime nodejs22 \
              --entry-point fetchDLsiteWorks \
              --trigger-topic dlsite-works-fetch-trigger \
              --region asia-northeast1 \
              --project ${{ secrets.GCP_PROJECT_ID }} \
              --set-env-vars NODE_ENV=production,FUNCTION_SIGNATURE_TYPE=cloudevent,FUNCTION_TARGET=fetchDLsiteWorks \
              --memory 512MB \
              --timeout 540s \
              --max-instances 10 \
              --quiet; then
              echo "âœ… fetchDLsiteWorks deployed successfully"
              break
            else
              echo "âŒ Deploy failed on attempt $attempt"
              if [ $attempt -eq 3 ]; then
                echo "ðŸš¨ All retry attempts failed"
                exit 1
              fi
              echo "â³ Waiting 30 seconds before retry..."
              sleep 30
            fi
          done

      - name: Cleanup deployment artifacts
        if: always()
        run: |
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -rf ./deployment-temp
          rm -f functions-deployment.zip
          
          # å¤ã„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ï¼ˆæœ€æ–°5å€‹ã‚’ä¿æŒï¼‰
          if [ ! -z "${{ env.BUCKET_NAME }}" ]; then
            echo "Cleaning up old deployment files..."
            gsutil ls gs://${{ env.BUCKET_NAME }}/functions-*.zip | \
              sort -r | \
              tail -n +6 | \
              xargs -r gsutil rm || echo "No old files to clean up"
          fi

      - name: Deploy status summary
        run: |
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤çµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚ŒãŸé–¢æ•°" >> $GITHUB_STEP_SUMMARY
          echo "- **fetchYouTubeVideos**: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† (ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ã)" >> $GITHUB_STEP_SUMMARY
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: \`youtube-video-fetch-trigger\` (Pub/Sub)" >> $GITHUB_STEP_SUMMARY
          echo "- **fetchDLsiteWorks**: âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† (ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ã)" >> $GITHUB_STEP_SUMMARY
          echo "  - ãƒˆãƒªã‚¬ãƒ¼: \`dlsite-works-fetch-trigger\` (Pub/Sub)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ è¨­å®šæƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: \`${{ secrets.GCP_PROJECT_ID }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: \`asia-northeast1\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ **: \`nodejs22\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ¡ãƒ¢ãƒª**: \`512MB\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: \`540ç§’\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‡ãƒ—ãƒ­ã‚¤ã‚½ãƒ¼ã‚¹**: \`${{ env.DEPLOYMENT_SOURCE }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›¡ï¸ æ”¹å–„ç‚¹" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… 3å›žã®ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã§ä¿¡é ¼æ€§å‘ä¸Š" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… é–¢æ•°ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é †æ¬¡å®Ÿè¡Œã—ã¦ç«¶åˆã‚’å›žé¿" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¤ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã®è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæœ€æ–°5å€‹ã‚’ä¿æŒï¼‰" >> $GITHUB_STEP_SUMMARY

      # Cleanup old Cloud Functions revisions
      - name: Cleanup old Cloud Functions revisions
        run: |
          echo "ðŸ§¹ Cleaning up old Cloud Functions revisions (keeping last 5 versions)"
          
          # Function names
          FUNCTIONS=("fetchyoutubevideos" "fetchdlsiteworks")
          KEEP_COUNT=5
          
          for function_name in "${FUNCTIONS[@]}"; do
            echo "Processing function: $function_name"
            
            # Get revisions sorted by creation time (newest first)
            revisions=$(gcloud run revisions list \
              --service="$function_name" \
              --region="asia-northeast1" \
              --project="${{ secrets.GCP_PROJECT_ID }}" \
              --sort-by="~metadata.creationTimestamp" \
              --format="value(metadata.name)" \
              --limit=20)
            
            if [ -z "$revisions" ]; then
              echo "No revisions found for $function_name"
              continue
            fi
            
            # Convert to array
            revision_array=($revisions)
            total_count=${#revision_array[@]}
            
            echo "Total revisions for $function_name: $total_count"
            
            if [ $total_count -le $KEEP_COUNT ]; then
              echo "Revision count is within keep limit, skipping cleanup"
              continue
            fi
            
            # Delete old revisions
            deleted=0
            for ((i=KEEP_COUNT; i<total_count; i++)); do
              revision=${revision_array[$i]}
              echo "Deleting revision: $revision"
              
              if gcloud run revisions delete "$revision" \
                --region="asia-northeast1" \
                --project="${{ secrets.GCP_PROJECT_ID }}" \
                --quiet; then
                deleted=$((deleted + 1))
              else
                echo "Failed to delete $revision, but continuing..."
              fi
            done
            
            echo "âœ… Deleted $deleted revisions for $function_name"
          done || true  # Don't fail the entire workflow if cleanup fails