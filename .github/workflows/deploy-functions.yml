name: 'Cloud Functionsãƒ‡ãƒ—ãƒ­ã‚¤'

on:
  # å†åˆ©ç”¨å¯èƒ½ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã—ã¦å‘¼ã³å‡ºã—å¯èƒ½
  workflow_call:
    inputs:
      branch:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ'
        required: true
        default: 'main'
        type: string
      trigger_source:
        description: 'ãƒˆãƒªã‚¬ãƒ¼å…ƒï¼ˆci ã¾ãŸã¯ manualï¼‰'
        required: false
        default: 'manual'
        type: string
  
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼
  workflow_dispatch:
    inputs:
      branch:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒ'
        required: true
        default: 'main'
        type: string
      trigger_source:
        description: 'ãƒˆãƒªã‚¬ãƒ¼å…ƒï¼ˆci ã¾ãŸã¯ manualï¼‰'
        required: false
        default: 'manual'
        type: string
  
  # ç‰¹å®šãƒ‘ã‚¹ã®å¤‰æ›´ã®å ´åˆã‚‚è‡ªå‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤
  push:
    branches:
      - main
    paths:
      # Cloud Functions å¤‰æ›´æ™‚ã®ã¿
      - 'apps/functions/**'

# Workload Identity Federationã«å¿…è¦ãªæ¨©é™è¨­å®š
permissions:
  contents: read
  id-token: write  # Google Cloudèªè¨¼ã«å¿…è¦

# ç’°å¢ƒå¤‰æ•°
env:
  REGION: 'asia-northeast1'

jobs:
  # ãƒ‡ãƒ—ãƒ­ã‚¤æ¡ä»¶ã®ç¢ºèªã¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã®èª­ã¿å–ã‚Š
  prepare-deployment:
    name: 'ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™'
    runs-on: ubuntu-latest
    outputs:
      deploy_branch: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || 'main' }}
      node_version: ${{ steps.read_engines.outputs.node_version }}
      pnpm_version: ${{ steps.read_engines.outputs.pnpm_version }}
      changed_functions: ${{ steps.changed-functions.outputs.names }}
      has_changes: ${{ steps.changed-functions.outputs.has_changes }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: ${{ github.event_name == 'push' && 2 || 1 }}  # pushæ™‚ã¯å·®åˆ†æ¤œå‡ºã®ãŸã‚2ã«è¨­å®š
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || 'main' }}
      
      # package.jsonã‹ã‚‰enginesã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿å–ã‚‹
      - name: ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ã‚¨ãƒ³ã‚¸ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’èª­ã¿å–ã‚‹
        id: read_engines
        run: |
          # package.jsonã‹ã‚‰Node.jsã¨pnpmã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—
          NODE_VERSION=$(node -p "require('./package.json').engines.node")
          PNPM_VERSION=$(node -p "require('./package.json').engines.pnpm")
          
          echo "å–å¾—ã—ãŸãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±: Node.js=$NODE_VERSION, pnpm=$PNPM_VERSION"
          
          # GitHub Actionsã®å‡ºåŠ›ã¨ã—ã¦è¨­å®š
          echo "node_version=$NODE_VERSION" >> $GITHUB_OUTPUT
          echo "pnpm_version=$PNPM_VERSION" >> $GITHUB_OUTPUT
      
      # pushã‚¤ãƒ™ãƒ³ãƒˆæ™‚ã¯å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã ã‘ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: å¤‰æ›´ã•ã‚ŒãŸé–¢æ•°ã®æ¤œå‡º
        id: changed-functions
        run: |
          # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ã¾ãŸã¯CIçµŒç”±ã®å ´åˆã¯å…¨é–¢æ•°ã‚’å¯¾è±¡ã«ã™ã‚‹
          if [ "${{ github.event_name }}" != "push" ]; then
            # index.tsãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç›´æ¥ç™»éŒ²ã•ã‚ŒãŸé–¢æ•°ã‚’æŠ½å‡ºã™ã‚‹
            echo "Cloud Functionsé–¢æ•°ã‚’æ¤œç´¢ä¸­..."
            
            # index.tsãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ˜ç¤ºçš„ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹é–¢æ•°ã‚’æŠ½å‡º
            INDEX_FILE="./apps/functions/src/index.ts"
            
            if [ ! -f "$INDEX_FILE" ]; then
              echo "ã‚¨ãƒ©ãƒ¼: index.tsãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $INDEX_FILE"
              exit 1
            fi
            
            # cloudEventã¨httpã§ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹é–¢æ•°åã‚’æŠ½å‡º
            CLOUD_EVENT_FUNCTIONS=$(grep -o 'functions\.cloudEvent.*"\w\+"' $INDEX_FILE | grep -o '"[^"]\+"' | tr -d '"' || echo "")
            HTTP_FUNCTIONS=$(grep -o 'functions\.http.*"\w\+"' $INDEX_FILE | grep -o '"[^"]\+"' | tr -d '"' || echo "")
            
            # çµæœã‚’ãƒãƒ¼ã‚¸
            ALL_FUNCTIONS="$CLOUD_EVENT_FUNCTIONS $HTTP_FUNCTIONS"
            
            # é‡è¤‡æ’é™¤ã¨æ•´å½¢
            FUNCTIONS=$(echo "$ALL_FUNCTIONS" | tr ' ' '\n' | grep -v '^$' | sort | uniq | tr '\n' ' ')
            
            # httpHandlerã¨healthcheckã¯ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç”¨ã®ãƒ€ãƒŸãƒ¼é–¢æ•°ãªã®ã§ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã‹ã‚‰é™¤å¤–
            FUNCTIONS=$(echo "$FUNCTIONS" | sed 's/\bhttpHandler\b//g' | sed 's/\bhealthcheck\b//g')
            
            # ç©ºç™½ã‚’æ•´ç†
            FUNCTIONS=$(echo "$FUNCTIONS" | tr -s ' ' | sed 's/^ *//;s/ *$//')
            
            # å®‰å…¨å¯¾ç­–ï¼šé–¢æ•°ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿã•ã›ã‚‹
            if [ -z "$FUNCTIONS" ]; then
              echo "ã‚¨ãƒ©ãƒ¼: é–¢æ•°ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
              exit 1
            fi
            
            echo "ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ã®é–¢æ•°ä¸€è¦§: $FUNCTIONS"
            echo "names=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰exportã•ã‚Œã¦ã„ã‚‹é–¢æ•°åã‚’æŠ½å‡º
            # HEAD^ HEADã¯åˆå›ã‚³ãƒŸãƒƒãƒˆãªã©ã§å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€merge-baseã‚’ä½¿ç”¨
            CHANGED_FILES=$(git diff --name-only $(git merge-base HEAD origin/${{ github.event.repository.default_branch || 'main' }}) HEAD | grep "^apps/functions/src/.*\.ts$" | grep -v "\.test\.ts$" || true)
            if [ -z "$CHANGED_FILES" ]; then
              echo "å¤‰æ›´ã•ã‚ŒãŸé–¢æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
              echo "names=" >> $GITHUB_OUTPUT
              echo "has_changes=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            FUNCTIONS=""
            for FILE in $CHANGED_FILES; do
              FUNCS=$(grep -o "export.*async function [a-zA-Z0-9_]\+" $FILE | sed -E 's/export.*function ([a-zA-Z0-9_]+).*/\1/' || true)
              if [ -n "$FUNCS" ]; then
                FUNCTIONS="$FUNCTIONS $FUNCS"
              fi
            done
            
            # é‡è¤‡ã‚’å‰Šé™¤ã—ã¦æ•´å½¢
            FUNCTIONS=$(echo "$FUNCTIONS" | tr ' ' '\n' | sort | uniq | tr '\n' ' ')
            echo "ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹é–¢æ•°: $FUNCTIONS"
            echo "names=$FUNCTIONS" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±ã‚’å‡ºåŠ›
        run: |
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±:"
          echo "- ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}"
          echo "- ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || 'main' }}"
          echo "- å¤‰æ›´ã•ã‚ŒãŸé–¢æ•°: ${{ steps.changed-functions.outputs.names }}"
          echo "- Node.js: ${{ steps.read_engines.outputs.node_version }}"
          echo "- pnpm: ${{ steps.read_engines.outputs.pnpm_version }}"
          echo "- ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "- å®Ÿè¡Œè€…: ${{ github.actor }}"
          echo "- æ—¥æ™‚: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')"

  # ç¾åœ¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹ã®ä¿å­˜ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
  save-current-state:
    name: 'ç¾åœ¨ã®ãƒ‡ãƒ—ãƒ­ã‚¤çŠ¶æ…‹ã‚’ä¿å­˜'
    needs: prepare-deployment
    runs-on: ubuntu-latest
    if: needs.prepare-deployment.outputs.has_changes == 'true'
    outputs:
      functions_state: ${{ steps.get-current-versions.outputs.functions_state }}
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆempty workspaceè­¦å‘Šã‚’è§£æ±ºï¼‰
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      # Google Cloudèªè¨¼
      - name: Google Cloudèªè¨¼ã®è¨­å®š
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/198349592327/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'cloud-functions-deployer-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'
          create_credentials_file: true
          export_environment_variables: true
      
      # gcloud CLIã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: gcloud CLIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.auth.outcome == 'success'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
      - name: ç¾åœ¨ã®é–¢æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
        id: get-current-versions
        run: |
          # å¤‰æ›´å¯¾è±¡ã®é–¢æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
          FUNCTIONS="${{ needs.prepare-deployment.outputs.changed_functions }}"
          FUNCTIONS_STATE=""
          
          for FUNC in $FUNCTIONS; do
            echo "é–¢æ•° $FUNC ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’å–å¾—ä¸­..."
            
            # é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            if gcloud functions describe $FUNC --gen2 --region=${{ env.REGION }} &> /dev/null; then
              # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³IDã‚’å–å¾—ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚·ãƒ¥ï¼‰
              SOURCE_HASH=$(gcloud functions describe $FUNC --gen2 --region=${{ env.REGION }} --format="value(buildConfig.sourceHash)" 2>/dev/null || echo "")
              
              if [ -n "$SOURCE_HASH" ]; then
                # ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚·ãƒ¥æƒ…å ±ã‚’è¿½åŠ 
                FUNCTIONS_STATE="${FUNCTIONS_STATE}${FUNC}:${SOURCE_HASH};"
                echo "é–¢æ•° $FUNC ã®ç¾åœ¨ã®ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚·ãƒ¥: $SOURCE_HASH"
              else
                echo "è­¦å‘Š: é–¢æ•° $FUNC ã®ã‚½ãƒ¼ã‚¹ãƒãƒƒã‚·ãƒ¥ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
                FUNCTIONS_STATE="${FUNCTIONS_STATE}${FUNC}:unknown;"
              fi
            else
              echo "æƒ…å ±: é–¢æ•° $FUNC ã¯æ–°è¦ä½œæˆã•ã‚Œã¾ã™ã€‚"
              FUNCTIONS_STATE="${FUNCTIONS_STATE}${FUNC}:new;"
            fi
          done
          
          # çµæœã‚’å‡ºåŠ›
          echo "functions_state=$FUNCTIONS_STATE" >> $GITHUB_OUTPUT
          echo "å–å¾—ã—ãŸé–¢æ•°ã®çŠ¶æ…‹: $FUNCTIONS_STATE"

  # Cloud Functionsã®ãƒ‡ãƒ—ãƒ­ã‚¤
  deploy-functions:
    name: 'Cloud Functionsãƒ‡ãƒ—ãƒ­ã‚¤'
    needs: [prepare-deployment, save-current-state]
    if: needs.prepare-deployment.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      deploy_results: ${{ steps.deploy-summary.outputs.results }}
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-deployment.outputs.deploy_branch }}
      
      # è¤‡åˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦Node.jsç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ./.github/actions/setup-node-env
        with:
          node-version: ${{ needs.prepare-deployment.outputs.node_version }}
          pnpm-version: ${{ needs.prepare-deployment.outputs.pnpm_version }}
          project-path: 'functions'

      # shared-typesã®ãƒ“ãƒ«ãƒ‰ï¼ˆfunctionsãŒä¾å­˜ã™ã‚‹ãŸã‚å…ˆã«å®Ÿè¡Œï¼‰
      - name: shared-typesã®ãƒ“ãƒ«ãƒ‰
        run: pnpm --filter @suzumina.click/shared-types build
      
      # Cloud Functionsã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Cloud Functionsã®ãƒ†ã‚¹ãƒˆ
        run: pnpm --filter @suzumina.click/functions test
      
      # Cloud Functionsã®ãƒ“ãƒ«ãƒ‰
      - name: Cloud Functionsã®ãƒ“ãƒ«ãƒ‰
        run: pnpm --filter @suzumina.click/functions build
      
      # ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æº–å‚™
      - name: monorepoå¯¾å¿œãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ä½œæˆ
        run: |
          echo "ğŸš€ monorepoå¯¾å¿œãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½œæˆä¸­..."
          node ./.github/scripts/create-deploy-package.js
          
          echo "ğŸ“„ ç”Ÿæˆã•ã‚ŒãŸpackage.json:"
          cat ./tmp/functions/package.json
          
          echo "ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å†…å®¹:"
          ls -la ./tmp/functions/
      
      # Google Cloudèªè¨¼
      - name: Google Cloudèªè¨¼ã®è¨­å®š
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: 'projects/198349592327/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'cloud-functions-deployer-sa@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com'
          create_credentials_file: true
          export_environment_variables: true
      
      # gcloud CLIã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: gcloud CLIã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        if: steps.auth.outcome == 'success'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      # ä¸è¦ãªé–¢æ•°ã®å‰Šé™¤
      - name: ä¸è¦ãªCloud Functionsã®å‰Šé™¤
        if: steps.auth.outcome == 'success'
        run: |
          echo "ä¸è¦ãªé–¢æ•°ã®å‰Šé™¤ã‚’å®Ÿè¡Œã—ã¾ã™..."
          
          # å‰Šé™¤å¯¾è±¡ã®é–¢æ•°ãƒªã‚¹ãƒˆ
          FUNCTIONS_TO_DELETE="healthcheck"
          
          for FUNC in $FUNCTIONS_TO_DELETE; do
            echo "é–¢æ•° $FUNC ã®å‰Šé™¤ã‚’è©¦è¡Œä¸­..."
            
            # é–¢æ•°ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if gcloud functions list --filter="name:projects/${{ secrets.GCP_PROJECT_ID }}/locations/asia-northeast1/functions/$FUNC" --format="value(name)" | grep -q "$FUNC"; then
              echo "é–¢æ•° $FUNC ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™..."
              gcloud functions delete $FUNC \
                --region=asia-northeast1 \
                --quiet || echo "é–¢æ•° $FUNC ã®å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™"
            else
              echo "é–¢æ•° $FUNC ã¯å­˜åœ¨ã—ãªã„ãŸã‚ã€å‰Šé™¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
            fi
          done
          
          echo "ä¸è¦ãªé–¢æ•°ã®å‰Šé™¤å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ"
      
      # é–¢æ•°ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Cloud Functionsã®ãƒ‡ãƒ—ãƒ­ã‚¤
        id: deploy-functions
        run: |
          # é–¢æ•°åã®ãƒªã‚¹ãƒˆã‚’ã‚¹ãƒšãƒ¼ã‚¹ã§åˆ†å‰²ã—ã¦å‡¦ç†
          FUNCTIONS="${{ needs.prepare-deployment.outputs.changed_functions }}"
          DEPLOY_RESULTS=""
          
          for FUNC in $FUNCTIONS; do
            echo "é–¢æ•° $FUNC ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™..."
            
            # é–¢æ•°ã®ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’æ¤œå‡º
            TRIGGER_TYPE=""
            TOPIC_NAME=""
            
            # index.tsãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’ç›´æ¥ç¢ºèª (å…ƒã®ã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨)
            if grep -q "functions\.cloudEvent.*\"$FUNC\"" ./apps/functions/src/index.ts; then
              TRIGGER_TYPE="pubsub"
              # Terraformãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯åã‚’å–å¾—
              TOPIC_ID=$(grep -A40 "name.*=.*\"$FUNC\"" ./terraform/*.tf | grep "pubsub_topic" | sed -E 's/.*pubsub_topic.*=.*"([^"]+)".*/\1/' || echo "")
              if [ -n "$TOPIC_ID" ]; then
                # google_pubsub_topic.ãƒˆãƒ”ãƒƒã‚¯å.id ã®å½¢å¼ã‹ã‚‰ãƒˆãƒ”ãƒƒã‚¯åã‚’æŠ½å‡º
                TOPIC_NAME=$(echo $TOPIC_ID | sed -E 's/.*google_pubsub_topic\.([^\.]+)\.id.*/\1/' || echo "")
              fi
            elif grep -q "functions\.http.*\"$FUNC\"" ./apps/functions/src/index.ts; then
              TRIGGER_TYPE="http"
            # é–¢æ•°ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å†…å®¹ã‚’ç¢ºèª
            elif [ -f "./apps/functions/src/$FUNC.ts" ]; then
              if grep -q "CloudEvent" "./apps/functions/src/$FUNC.ts"; then
                TRIGGER_TYPE="pubsub"
              elif grep -q "Request.*Response" "./apps/functions/src/$FUNC.ts"; then
                TRIGGER_TYPE="http"
              fi
            fi
            
            # ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ãŒæ¤œå‡ºã§ããªã„å ´åˆã¯è­¦å‘Šã‚’è¡¨ç¤º
            if [ -z "$TRIGGER_TYPE" ]; then
              echo "è­¦å‘Š: é–¢æ•° $FUNC ã®ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚"
              echo "  é–¢æ•°ã¯æ­£ã—ãç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ index.ts ã§ functions.cloudEvent ã¾ãŸã¯ functions.http ã‚’ä½¿ç”¨ã—ã¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚"
              DEPLOY_RESULTS="${DEPLOY_RESULTS}${FUNC}:failed (ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ä¸æ˜);"
              continue
            fi
            
            # ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ã«åŸºã¥ã„ã¦é©åˆ‡ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
            TRIGGER_PARAMS=""
            
            case $TRIGGER_TYPE in
              http)
                # HTTPãƒˆãƒªã‚¬ãƒ¼
                TRIGGER_PARAMS="--trigger-http"
                ;;
              pubsub)
                # Pub/Subãƒˆãƒªã‚¬ãƒ¼
                if [ -n "$TOPIC_NAME" ]; then
                  echo "Pub/Subãƒˆãƒªã‚¬ãƒ¼: ãƒˆãƒ”ãƒƒã‚¯ '$TOPIC_NAME' ã‚’ä½¿ç”¨ã—ã¾ã™"
                  TRIGGER_PARAMS="--trigger-topic=$TOPIC_NAME"
                else
                  # ãƒˆãƒ”ãƒƒã‚¯åãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ”ãƒƒã‚¯åã‚’ä½¿ç”¨
                  echo "è­¦å‘Š: Pub/Subãƒˆãƒªã‚¬ãƒ¼ç”¨ã®ãƒˆãƒ”ãƒƒã‚¯åãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåã‚’ä½¿ç”¨ã—ã¾ã™ã€‚"
                  TRIGGER_PARAMS="--trigger-topic=youtube-video-fetch-trigger"
                fi
                ;;
              *)
                echo "ä¸æ˜ãªãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—ã§ã™: $TRIGGER_TYPE"
                DEPLOY_RESULTS="${DEPLOY_RESULTS}${FUNC}:failed (ä¸æ˜ãªãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—);"
                continue
                ;;
            esac
            
            echo "ãƒˆãƒªã‚¬ãƒ¼ã‚¿ã‚¤ãƒ—: $TRIGGER_TYPE, ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: $TRIGGER_PARAMS"
            
            # gcloudã‚³ãƒãƒ³ãƒ‰ã§é–¢æ•°ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
            if gcloud functions deploy $FUNC \
              --gen2 \
              --region=${{ env.REGION }} \
              --runtime=nodejs20 \
              --source=./tmp/functions \
              --entry-point=$FUNC \
              --no-user-output-enabled \
              $TRIGGER_PARAMS \
              --set-env-vars=FUNCTION_SIGNATURE_TYPE=cloudevent,FUNCTION_TARGET=$FUNC; then
              
              echo "é–¢æ•° $FUNC ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«æˆåŠŸã—ã¾ã—ãŸ"
              DEPLOY_RESULTS="${DEPLOY_RESULTS}${FUNC}:success;"
            else
              echo "é–¢æ•° $FUNC ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
              DEPLOY_RESULTS="${DEPLOY_RESULTS}${FUNC}:failed (ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¨ãƒ©ãƒ¼);"
            fi
          done
          
          echo "deploy_results=$DEPLOY_RESULTS" >> $GITHUB_OUTPUT
      
      # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
        id: deploy-summary
        run: |
          DEPLOY_RESULTS="${{ steps.deploy-functions.outputs.deploy_results }}"
          echo "çµæœ: $DEPLOY_RESULTS"
          echo "results=$DEPLOY_RESULTS" >> $GITHUB_OUTPUT
          
          # å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆ
          FAILED_COUNT=$(echo "$DEPLOY_RESULTS" | grep -o "failed" | wc -l)
          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "::warning::$FAILED_COUNT å€‹ã®é–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
          else
            echo "::notice::ã™ã¹ã¦ã®é–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«æˆåŠŸã—ã¾ã—ãŸ"
          fi



  # æ³¨æ„: Cloud Functions Gen2ã§ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ç›´æ¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãŸã‚ã€
  # è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯æ‰‹å‹•ã§ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

  # å¤‰æ›´ãŒãªã‹ã£ãŸå ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  no-changes-notification:
    name: 'å¤‰æ›´ãªã—é€šçŸ¥'
    needs: prepare-deployment
    if: needs.prepare-deployment.outputs.has_changes != 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ä¸è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        run: |
          echo "::notice title=Cloud Functionså¤‰æ›´ãªã—::ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…è¦ãªé–¢æ•°ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"

  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥
  notify-deployment:
    name: 'ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†é€šçŸ¥'
    needs: [prepare-deployment, deploy-functions]
    if: needs.prepare-deployment.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥
        run: |
          # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã«åŸºã¥ã„ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†å²
          DEPLOY_RESULTS="${{ needs.deploy-functions.outputs.deploy_results }}"
          FAILED_COUNT=$(echo "$DEPLOY_RESULTS" | grep -o "failed" | wc -l)
          
          if [ "$FAILED_COUNT" -eq 0 ]; then
            echo "::notice title=Cloud Functionsãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸ::ã™ã¹ã¦ã®é–¢æ•°ãŒæ­£å¸¸ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ"
          else
            echo "::warning title=Cloud Functionsãƒ‡ãƒ—ãƒ­ã‚¤ä¸€éƒ¨å¤±æ•—::$FAILED_COUNT å€‹ã®é–¢æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
            echo "- ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ: $DEPLOY_RESULTS"
          fi
          
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚: $(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')"
          echo "ãƒˆãƒªã‚¬ãƒ¼: ${{ github.event_name }}"
          echo "å®Ÿè¡Œè€…: ${{ github.actor }}"