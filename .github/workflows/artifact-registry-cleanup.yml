name: Artifact Registry Cleanup

on:
  # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œï¼ˆJST 11æ™‚ï¼‰
  schedule:
    - cron: '0 2 * * *'
  
  # Manual triggering
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (true/false)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: asia-northeast1
  REPOSITORY: suzumina-click-web

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: latest
      
      - name: Verify authentication
        run: gcloud auth list
      
      - name: Clean up old images
        run: |
          echo "ğŸ§¹ Starting Artifact Registry cleanup..."
          
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"
          REPOSITORY_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}"
          
          # é–¢æ•°: ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          cleanup_images() {
            local image_name=$1
            local keep_count=$2
            
            echo "ğŸ“¦ Processing ${image_name} (keeping ${keep_count} recent images)..."
            
            # ã‚¿ã‚°ä»˜ãã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¸€è¦§ã‚’å–å¾—ï¼ˆä½œæˆæ—¥æ™‚ã®é™é †ï¼‰
            local tagged_images=$(gcloud artifacts docker images list \
              ${REPOSITORY_PATH}/${image_name} \
              --include-tags \
              --filter="tags:*" \
              --format="value(IMAGE@DIGEST,createTime)" \
              --sort-by="~createTime" | head -n ${keep_count})
            
            if [ -z "$tagged_images" ]; then
              echo "â„¹ï¸  No tagged images found for ${image_name}"
              return
            fi
            
            echo "âœ… Keeping ${keep_count} most recent tagged images for ${image_name}"
            
            # å¤ã„ã‚¿ã‚°ãªã—ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤
            local untagged_images=$(gcloud artifacts docker images list \
              ${REPOSITORY_PATH}/${image_name} \
              --filter="NOT tags:* AND createTime < '$(date -d '7 days ago' -u +%Y-%m-%dT%H:%M:%SZ)'" \
              --format="value(IMAGE@DIGEST)")
            
            if [ -n "$untagged_images" ]; then
              echo "ğŸ—‘ï¸  Found $(echo "$untagged_images" | wc -l) old untagged images to delete"
              
              if [ "$DRY_RUN" = "true" ]; then
                echo "ğŸ” DRY RUN: Would delete the following untagged images:"
                echo "$untagged_images"
              else
                echo "Deleting old untagged images..."
                echo "$untagged_images" | while read -r image_digest; do
                  if [ -n "$image_digest" ]; then
                    echo "Deleting: $image_digest"
                    gcloud artifacts docker images delete "$image_digest" --quiet || echo "Failed to delete $image_digest"
                  fi
                done
              fi
            else
              echo "âœ¨ No old untagged images to delete for ${image_name}"
            fi
            
            # cache ã‚¿ã‚°ã®ä»˜ã„ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤
            local cache_images=$(gcloud artifacts docker tags list \
              ${REPOSITORY_PATH}/${image_name} \
              --filter="tag:cache" \
              --format="value(name)")
            
            if [ -n "$cache_images" ]; then
              echo "ğŸ§¹ Found cache tagged images to clean up"
              
              if [ "$DRY_RUN" = "true" ]; then
                echo "ğŸ” DRY RUN: Would delete cache tags:"
                echo "$cache_images"
              else
                echo "Deleting cache tags..."
                echo "$cache_images" | while read -r cache_tag; do
                  if [ -n "$cache_tag" ]; then
                    echo "Deleting cache tag: $cache_tag"
                    gcloud artifacts docker tags delete "$cache_tag" --quiet || echo "Failed to delete cache tag $cache_tag"
                  fi
                done
              fi
            fi
          }
          
          echo "ğŸ Starting cleanup process..."
          
          # ãƒ¡ã‚¤ãƒ³Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæœ€æ–°5ã¤ã‚’ä¿æŒï¼‰
          cleanup_images "web" 5
          
          # Admin ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆæœ€æ–°3ã¤ã‚’ä¿æŒï¼‰
          cleanup_images "suzumina-admin" 3
          
          echo "âœ… Artifact Registry cleanup completed!"
          
      - name: Report cleanup results
        run: |
          echo "ğŸ“Š Post-cleanup repository status:"
          gcloud artifacts repositories list --project=${{ env.PROJECT_ID }} --location=${{ env.REGION }}
          
          echo ""
          echo "ğŸ“¦ Current images in repository:"
          gcloud artifacts docker images list \
            ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }} \
            --include-tags \
            --limit=20
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Artifact Registry cleanup failed!"
          echo "Please check the workflow logs for details."