# PostgreSQL移行状況

## 概要

本文書は、SQLiteからPostgreSQLへの移行計画の実施状況を記録します。移行計画の詳細は[POSTGRESQL_MIGRATION_PLAN.md](./POSTGRESQL_MIGRATION_PLAN.md)を参照してください。

## 実装済みの項目

### 1. 技術的な実装

- [x] PostgreSQL用のスキーマ定義（`apps/web/src/db/schema.ts`）
  - pgTableを使用したスキーマ定義
  - タイムスタンプ型の適切な使用
  - リレーションの設定

- [x] データベース接続の設定（`apps/web/src/db/index.ts`）
  - 環境に応じたデータベース接続の切り替え
  - SQLiteとPostgreSQLの両対応

- [x] マイグレーション設定の更新（`drizzle.config.ts`）
  - 環境に応じたドライバーの切り替え
  - マイグレーション出力の設定

### 2. インフラストラクチャ

- [x] Cloud SQLインスタンスの設定（Terraform）
  - インスタンス定義
  - バックアップ設定
  - ネットワーク設定

- [x] Secret Managerの設定
  - データベース接続情報の管理
  - 環境変数の安全な管理

### 3. テストと検証

- [x] ローカル環境でのPostgreSQLテスト
  - Dockerを使用したテスト環境
  - マイグレーションテスト
  - 認証フローテスト

- [x] モニタリング設定
  - Cloud Monitoringダッシュボード
  - アラート設定

## 進行中の項目

### 1. インフラストラクチャ

- [ ] GCP本番環境（suzumina-click）のセットアップ
  - インフラストラクチャのデプロイ
  - データベースの初期設定

### 2. デプロイメント

- [ ] GCP本番環境へのデプロイ
  - マイグレーションの実行
  - アプリケーションのデプロイ

### 3. 監視と運用

- [ ] 本番環境でのモニタリング
  - パフォーマンス監視
  - エラー監視
  - リソース使用状況の監視

## 今後の課題

1. **パフォーマンス最適化**
   - クエリの最適化
   - インデックス設計の見直し
   - コネクションプールの調整

2. **セキュリティ強化**
   - アクセス制御の見直し
   - 監査ログの設定
   - セキュリティパッチの適用計画

3. **運用管理**
   - バックアップ/リストア手順の整備
   - メンテナンス計画の策定
   - インシデント対応手順の作成

## 参考文書

- [環境定義](../ENVIRONMENTS.md)
- [PostgreSQLデプロイ手順](./POSTGRESQL_DEPLOYMENT_PROCEDURE.md)
- [PostgreSQL移行計画](./POSTGRESQL_MIGRATION_PLAN.md)（当初の計画）

最終更新日: 2025年4月11日
