# DLsite çµ±åˆAPIåé›†ã‚·ã‚¹ãƒ†ãƒ  å®Ÿè£…ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ v10.1

## ğŸ“‹ æ¦‚è¦

Individual Info API ã«ã‚ˆã‚‹çµ±åˆãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ ã€‚1ã¤ã®Cloud Functionã§åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã¨æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿åé›†ã‚’åŒæ™‚å®Ÿè¡Œã—ã€é‡è¤‡å‘¼ã³å‡ºã—ã‚’å®Œå…¨æ’é™¤ã€‚ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°å¯¾å¿œã«ã‚ˆã‚‹å’Œé›†åˆã‚¢ã‚¯ã‚»ã‚¹æ©Ÿèƒ½ã¨æ—¥æ¬¡é›†è¨ˆã«ã‚ˆã‚‹é•·æœŸãƒ‡ãƒ¼ã‚¿åˆ†æã‚’å®Ÿç¾ã€‚

**å®Ÿè£…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ + æ—¥æ¬¡é›†è¨ˆå®Ÿè£…å®Œäº†ï¼ˆ2025å¹´7æœˆ9æ—¥ï¼‰**

## ğŸš€ çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®è¨­è¨ˆæ€æƒ³

### åŠ¹ç‡åŒ–å®Ÿç¾
- **APIå‘¼ã³å‡ºã—**: 50%å‰Šæ¸›ï¼ˆé‡è¤‡å‘¼ã³å‡ºã—æ’é™¤ï¼‰
- **ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§**: 100%ä¿è¨¼ï¼ˆåŒä¸€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰æ´¾ç”Ÿï¼‰
- **é‹ç”¨ç°¡ç´ åŒ–**: ç®¡ç†å¯¾è±¡Function 67%å‰Šæ¸›ï¼ˆ3ã¤â†’2ã¤ï¼‰
- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å®Œå…¨æ€§**: 100%ä¿è¨¼ï¼ˆå’Œé›†åˆã«ã‚ˆã‚‹å…¨ä½œå“ã‚¢ã‚¯ã‚»ã‚¹ï¼‰

### ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆåŸå‰‡
- **å˜ä¸€è²¬ä»»**: 1ã¤ã®Functionã§åŒ…æ‹¬çš„ãƒ‡ãƒ¼ã‚¿å‡¦ç†
- **ãƒ‡ãƒ¼ã‚¿åŒæœŸ**: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã¨æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨åŒæœŸ
- **åŠ¹ç‡æœ€å¤§åŒ–**: Individual Info APIã®1å›å‘¼ã³å‡ºã—ã§2ã¤ã®ç›®çš„é”æˆ
- **å®Œå…¨æ€§ä¿è¨¼**: ãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™ã‚’è¶…è¶Šã—ãŸå…¨ä½œå“ãƒ‡ãƒ¼ã‚¿åé›†

---

## ğŸ—ï¸ çµ±åˆã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### çµ±åˆCloud Functionå®Ÿè£…

#### **DLsiteçµ±åˆãƒ‡ãƒ¼ã‚¿åé›†Function**
```typescript
// Cloud Functionså: fetchDLsiteWorksIndividualAPI
// å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«: apps/functions/src/endpoints/dlsite-individual-info-api.ts
// å®Ÿè¡Œé »åº¦: æ¯æ™‚0åˆ†ï¼ˆ1500ä½œå“å…¨ä»¶å‡¦ç†ãƒ»å’Œé›†åˆã‚¢ã‚¯ã‚»ã‚¹ï¼‰
// ç›®çš„: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ›´æ–° + æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿åé›† + æ—¥æ¬¡é›†è¨ˆã®çµ±åˆå®Ÿè¡Œ

interface DLsiteUnifiedDataCollectionFunction {
  functionName: "fetchDLsiteWorksIndividualAPI";
  trigger: "Cloud Scheduler: 0 * * * *";  // æ¯æ™‚0åˆ†
  timeout: 540;    // 9åˆ†
  memory: "2GB";   // å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†å¯¾å¿œ
  
  responsibilities: [
    "å’Œé›†åˆã«ã‚ˆã‚‹å®Œå…¨IDåé›†ï¼ˆ1500ä»¶ï¼‰",
    "Individual Info APIçµ±åˆå–å¾—",
    "OptimizedFirestoreDLsiteWorkDataå½¢å¼ã§ã®åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ›´æ–°",
    "æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»æ—¥æ¬¡é›†è¨ˆå‡¦ç†",
    "ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°çµ±è¨ˆã®è¨˜éŒ²ãƒ»ç›£è¦–"
  ];
}
```

### çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   DLsiteçµ±åˆãƒ‡ãƒ¼ã‚¿åé›†Function (v10.1)                        â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å’Œé›†åˆIDåé›†      â”‚  â”‚ Individual Info â”‚  â”‚      çµ±åˆãƒ‡ãƒ¼ã‚¿å‡¦ç†           â”‚ â”‚
â”‚  â”‚                â”‚  â”‚ API (1å›å‘¼ã³å‡ºã—) â”‚  â”‚                           â”‚ â”‚
â”‚  â”‚ ãƒ»ç¾åœ¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³  â”‚  â”‚                â”‚  â”‚ ãƒ»åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ›´æ–°            â”‚ â”‚
â”‚  â”‚ ãƒ»ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ« â”‚â”€â”€â†’â”‚ ãƒ»1500ä½œå“å…¨ä»¶   â”‚â”€â”€â†’â”‚ ãƒ»æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿åé›†          â”‚ â”‚
â”‚  â”‚ ãƒ»å’Œé›†åˆä½œæˆ     â”‚  â”‚ ãƒ»æ¯æ™‚0åˆ†å®Ÿè¡Œ    â”‚  â”‚ ãƒ»æ—¥æ¬¡é›†è¨ˆå‡¦ç†             â”‚ â”‚
â”‚  â”‚ ãƒ»å·®ç•°æ¤œå‡ºãƒ»çµ±è¨ˆ  â”‚  â”‚ ãƒ»å®Œå…¨ã‚«ãƒãƒ¬ãƒƒã‚¸ â”‚  â”‚ ãƒ»ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§ä¿è¨¼          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                    â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                       â†“                       â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ä¿å­˜    â”‚    â”‚ æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿å‡¦ç†  â”‚    â”‚ çµ±ä¸€è² è·åˆ¶å¾¡      â”‚
   â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
   â”‚ ãƒ»ä½œå“è©³ç´°æƒ…å ±   â”‚    â”‚ ãƒ»ç”Ÿãƒ‡ãƒ¼ã‚¿åé›†   â”‚    â”‚ ãƒ»ãƒ¬ãƒ¼ãƒˆåˆ¶é™      â”‚
   â”‚ ãƒ»OptimizedData â”‚    â”‚ ãƒ»æ—¥æ¬¡é›†è¨ˆå‡¦ç†   â”‚    â”‚ ãƒ»ã‚¨ãƒ©ãƒ¼å‡¦ç†      â”‚
   â”‚ ãƒ»å³åº§åæ˜       â”‚    â”‚ ãƒ»é•·æœŸä¿å­˜      â”‚    â”‚ ãƒ»ç›£è¦–ãƒ»ãƒ­ã‚°      â”‚
   â”‚ ãƒ»100%ã‚«ãƒãƒ¬ãƒƒã‚¸ â”‚    â”‚ ãƒ»APIé«˜é€ŸåŒ–     â”‚    â”‚ ãƒ»å’Œé›†åˆçµ±è¨ˆ      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°å¯¾å¿œæ©Ÿèƒ½

### èª²é¡Œã¨ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³

**èª²é¡Œ**: Cloud Functionsãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™
- æ—¥æœ¬ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹: DLsite AJAX API â†’ 1500ä½œå“è¡¨ç¤º
- Cloud Functions (us-central1): DLsite AJAX API â†’ 1000ä½œå“è¡¨ç¤º
- **çµæœ**: 400ä½œå“ãŒã€Œè¦‹ãˆãªã„ã€çŠ¶æ…‹

**ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³**: å’Œé›†åˆã‚¢ã‚¯ã‚»ã‚¹æ©Ÿèƒ½
```typescript
// å®Ÿè£…å ´æ‰€: apps/functions/src/services/dlsite/work-id-validator.ts
export function createUnionWorkIds(currentRegionIds: string[]): UnionWorkIdResult {
  // 1. ç¾åœ¨ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§å–å¾—å¯èƒ½ãªID (ä¾‹: 1000ä»¶)
  // 2. é–‹ç™ºç’°å¢ƒã§åé›†ãƒ»ä¿å­˜æ¸ˆã¿ã®å®Œå…¨IDãƒªã‚¹ãƒˆ (1500ä»¶)
  // 3. å’Œé›†åˆä½œæˆ: 1000 âˆª 1500 = 1500ä»¶å®Œå…¨ãƒªã‚¹ãƒˆ
  // 4. Individual Info APIã§å…¨IDã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹
}
```

### ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
```
å ´æ‰€: apps/functions/src/assets/dlsite-work-ids.json
åé›†æ–¹æ³•: pnpm --filter @suzumina.click/functions collect:work-ids
æ›´æ–°é »åº¦: æ‰‹å‹•ï¼ˆæ–°ä½œå“è¿½åŠ æ™‚ï¼‰
ç”¨é€”: Cloud Functionsãƒªãƒ¼ã‚¸ãƒ§ãƒ³åˆ¶é™å›é¿ã®ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
```

---

## ğŸ“Š æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿æ—¥æ¬¡é›†è¨ˆä»•æ§˜

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ
```
ç”Ÿãƒ‡ãƒ¼ã‚¿åé›† â†’ æ—¥æ¬¡é›†è¨ˆç”Ÿæˆ â†’ é•·æœŸä¿å­˜ â†’ APIæä¾›
     â†“              â†“            â†“        â†“
7æ—¥é–“ä¿æŒ    æ°¸ç¶šä¿å­˜     é«˜é€ŸåŒ–   ä¾¡æ ¼å±¥æ­´
(é«˜é »åº¦)      (ä½é »åº¦)     (é›†è¨ˆ)    (åˆ†æ)
```

### é›†è¨ˆå‡¦ç†ã®è©³ç´°

#### **1. ç”Ÿãƒ‡ãƒ¼ã‚¿åé›†**
```typescript
// ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: dlsite_timeseries_raw
interface TimeSeriesRawData {
  workId: string;
  date: string;           // YYYY-MM-DD
  time: string;           // HH:mm:ss
  timestamp: string;      // ISO8601
  regionalPrices: {       // 6åœ°åŸŸã®ä¾¡æ ¼æƒ…å ±
    JP: number; US: number; EU: number;
    CN: number; TW: number; KR: number;
  };
  discountRate: number;
  campaignId?: number;
  wishlistCount?: number;
  ratingAverage?: number;
  ratingCount?: number;
  rankDay?: number;
  rankWeek?: number;
  rankMonth?: number;
}
```

#### **2. æ—¥æ¬¡é›†è¨ˆå‡¦ç†**
```typescript
// ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³: dlsite_timeseries_daily
interface TimeSeriesDailyAggregate {
  workId: string;
  date: string;                    // YYYY-MM-DD
  
  // ä¾¡æ ¼é›†è¨ˆï¼ˆæœ€å®‰å€¤ï¼‰
  lowestPrices: RegionalPrice;     // å„åœ°åŸŸã®æ—¥æ¬¡æœ€å®‰å€¤
  maxDiscountRate: number;         // æœ€å¤§å‰²å¼•ç‡
  activeCampaignIds: number[];     // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ID
  
  // çµ±è¨ˆé›†è¨ˆï¼ˆæœ€å¤§å€¤ï¼‰
  maxWishlistCount?: number;       // æœ€å¤§ã‚¦ã‚£ãƒƒã‚·ãƒ¥ãƒªã‚¹ãƒˆæ•°
  maxRatingAverage?: number;       // æœ€é«˜è©•ä¾¡å¹³å‡
  maxRatingCount?: number;         // æœ€å¤§è©•ä¾¡æ•°
  
  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°é›†è¨ˆï¼ˆæœ€é«˜é †ä½ = æœ€å°æ•°å€¤ï¼‰
  bestRankDay?: number;            // æ—¥æ¬¡æœ€é«˜ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  bestRankWeek?: number;           // é€±æ¬¡æœ€é«˜ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  bestRankMonth?: number;          // æœˆæ¬¡æœ€é«˜ãƒ©ãƒ³ã‚­ãƒ³ã‚°
  
  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  dataPointCount: number;          // ç”Ÿãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆæ•°
  firstCaptureTime: string;        // åˆå›å–å¾—æ™‚åˆ»
  lastCaptureTime: string;         // æœ€çµ‚å–å¾—æ™‚åˆ»
}
```

#### **3. çµ±åˆå‡¦ç†ãƒ•ãƒ­ãƒ¼**
```
1. Individual Info API ãƒ‡ãƒ¼ã‚¿å–å¾—
   â†“
2. æ™‚ç³»åˆ—ç”Ÿãƒ‡ãƒ¼ã‚¿ä¿å­˜ (saveMultipleTimeSeriesRawData)
   â†“
3. æ—¥æ¬¡é›†è¨ˆå‡¦ç†å®Ÿè¡Œ (batchProcessDailyAggregates)
   â†“
4. æ—¥æ¬¡é›†è¨ˆãƒ‡ãƒ¼ã‚¿ä¿å­˜ (dlsite_timeseries_daily)
   â†“
5. ä¾¡æ ¼å±¥æ­´API (é•·æœŸãƒ‡ãƒ¼ã‚¿æä¾›)
```

---

## ğŸ—„ï¸ Cloud Firestoreã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æ§‹é€ 

### DLsiteé–¢é€£ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

#### **1. ä½œå“åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ (`dlsiteWorks`)**
```typescript
interface OptimizedFirestoreDLsiteWorkData {
  productId: string;                    // ä½œå“ID (RJ123456)
  title: string;                       // ä½œå“ã‚¿ã‚¤ãƒˆãƒ«
  circle: string;                      // ã‚µãƒ¼ã‚¯ãƒ«å
  category: WorkCategory;              // ã‚«ãƒ†ã‚´ãƒª (SOU, ADV, etc.)
  
  // ä¾¡æ ¼æƒ…å ±
  priceInfo: {
    current: number;                   // ç¾åœ¨ä¾¡æ ¼
    original?: number;                 // å…ƒä¾¡æ ¼
    discount?: number;                 // å‰²å¼•ç‡
  };
  
  // è©•ä¾¡æƒ…å ±
  ratingInfo: {
    average: number;                   // å¹³å‡è©•ä¾¡
    count: number;                     // è©•ä¾¡æ•°
    distribution: { [key: string]: number }; // æ˜Ÿåˆ¥åˆ†å¸ƒ
  };
  
  // è©³ç´°æƒ…å ±
  detailedInfo: {
    tracks?: TrackInfo[];              // ãƒˆãƒ©ãƒƒã‚¯æƒ…å ±
    files?: FileInfo[];                // ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±
    creators?: DetailedCreatorInfo[];  // è©³ç´°ã‚¯ãƒªã‚¨ã‚¤ã‚¿ãƒ¼æƒ…å ±
    bonusContent?: BonusContent[];     // ç‰¹å…¸æƒ…å ±
  };
  
  // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
  createdAt: Timestamp;
  updatedAt: Timestamp;
  lastAPIFetch: Timestamp;
}
```

#### **2. æ™‚ç³»åˆ—ç”Ÿãƒ‡ãƒ¼ã‚¿ (`dlsite_timeseries_raw`)**
```typescript
// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID: {workId}_{YYYY-MM-DD}_{HH-mm-ss}
// ä¿æŒæœŸé–“: 7æ—¥é–“ï¼ˆè‡ªå‹•å‰Šé™¤ï¼‰
// ç”¨é€”: é«˜é »åº¦ãƒ‡ãƒ¼ã‚¿åé›†ãƒ»æ—¥æ¬¡é›†è¨ˆã®å…ƒãƒ‡ãƒ¼ã‚¿

interface TimeSeriesRawData {
  workId: string;
  date: string;
  time: string;
  timestamp: Timestamp;
  regionalPrices: RegionalPrice;       // 6åœ°åŸŸä¾¡æ ¼
  discountRate: number;
  campaignId?: number;
  wishlistCount?: number;
  ratingAverage?: number;
  ratingCount?: number;
  rankDay?: number;
  rankWeek?: number;
  rankMonth?: number;
  createdAt: Timestamp;
}
```

#### **3. æ™‚ç³»åˆ—æ—¥æ¬¡é›†è¨ˆ (`dlsite_timeseries_daily`)**
```typescript
// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID: {workId}_{YYYY-MM-DD}
// ä¿æŒæœŸé–“: æ°¸ç¶šä¿å­˜
// ç”¨é€”: ä¾¡æ ¼å±¥æ­´ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ¨ç§»API

interface TimeSeriesDailyAggregate {
  workId: string;
  date: string;
  lowestPrices: RegionalPrice;         // æ—¥æ¬¡æœ€å®‰å€¤
  maxDiscountRate: number;
  activeCampaignIds: number[];
  maxWishlistCount?: number;
  bestRankDay?: number;
  bestRankWeek?: number;
  bestRankMonth?: number;
  maxRatingAverage?: number;
  maxRatingCount?: number;
  dataPointCount: number;
  firstCaptureTime: string;
  lastCaptureTime: string;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### ç®¡ç†ãƒ»ç›£è¦–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³

#### **4. çµ±åˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ (`dlsiteMetadata`)**
```typescript
// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID: unified_data_collection_metadata
// ç”¨é€”: çµ±åˆãƒ‡ãƒ¼ã‚¿åé›†ã®çŠ¶æ…‹ç®¡ç†

interface UnifiedDataCollectionMetadata {
  lastFetchedAt: Timestamp;
  isInProgress: boolean;
  lastSuccessfulCompleteFetch?: Timestamp;
  totalWorks?: number;
  processedWorks?: number;
  basicDataUpdated?: number;
  timeSeriesCollected?: number;
  regionOnlyIds?: number;              // ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å°‚ç”¨IDæ•°
  assetOnlyIds?: number;               // ã‚¢ã‚»ãƒƒãƒˆå°‚ç”¨IDæ•°
  unionTotalIds?: number;              // å’Œé›†åˆç·IDæ•°
  regionDifferenceDetected?: boolean;  // ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°æ¤œå‡ºãƒ•ãƒ©ã‚°
}
```

#### **5. æ™‚ç³»åˆ—ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å®šæ•°**
```typescript
export const TIMESERIES_COLLECTIONS = {
  RAW_DATA: "dlsite_timeseries_raw",           // ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆ7æ—¥é–“ä¿æŒï¼‰
  DAILY_AGGREGATES: "dlsite_timeseries_daily", // æ—¥æ¬¡é›†è¨ˆãƒ‡ãƒ¼ã‚¿ï¼ˆæ°¸ç¶šä¿å­˜ï¼‰
  PRICE_CHARTS: "dlsite_price_charts",         // ä¾¡æ ¼å±¥æ­´ãƒãƒ£ãƒ¼ãƒˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
  RANKING_CHARTS: "dlsite_ranking_charts",     // ãƒ©ãƒ³ã‚­ãƒ³ã‚°å±¥æ­´ãƒãƒ£ãƒ¼ãƒˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
} as const;
```

---

## ğŸ“… å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Cloud Schedulerè¨­å®š
```typescript
const SCHEDULE = {
  // çµ±åˆãƒ‡ãƒ¼ã‚¿åé›†ï¼ˆæ¯æ™‚å®Ÿè¡Œï¼‰
  "0 * * * *": "fetchDLsiteWorksIndividualAPI",
  
  // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆ30åˆ†é–“éš”ï¼‰
  "*/30 * * * *": "DLsiteãƒ˜ãƒ«ã‚¹ç›£è¦–",
};
```

### å‡¦ç†é †åº
1. **æ¯æ™‚0åˆ†**: çµ±åˆãƒ‡ãƒ¼ã‚¿åé›†é–‹å§‹
2. **å’Œé›†åˆIDåé›†**: ç¾åœ¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ + ã‚¢ã‚»ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«
3. **Individual Info API**: 1500ä½œå“ä¸€æ‹¬å–å¾—
4. **ä¸¦åˆ—å‡¦ç†**: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ›´æ–° + æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿åé›†
5. **æ—¥æ¬¡é›†è¨ˆ**: éå»1æ—¥åˆ†ã®ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
6. **å®Œäº†**: çµ±è¨ˆæƒ…å ±è¨˜éŒ²ãƒ»ãƒ­ã‚°å‡ºåŠ›

---

## ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å®Ÿç¸¾

| æŒ‡æ¨™ | å®Ÿç¸¾å€¤ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|------|--------|------|
| å®Ÿè¡Œæ™‚é–“ | 5åˆ†ä»¥å†… | âœ… ç›®æ¨™é”æˆ |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ | 2GBä»¥å†… | âœ… åŠ¹ç‡çš„ãªåˆ©ç”¨ |
| APIå‘¼ã³å‡ºã—é‡è¤‡æ’é™¤ | 100% | âœ… å®Œå…¨å®Ÿè£… |
| ãƒ‡ãƒ¼ã‚¿åŒæœŸç‡ | 100% | âœ… åŒä¸€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ä½¿ç”¨ |
| ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚«ãƒãƒ¬ãƒƒã‚¸ | 100% | âœ… å’Œé›†åˆã«ã‚ˆã‚‹å®Œå…¨å–å¾— |
| æ—¥æ¬¡é›†è¨ˆå‡¦ç† | è‡ªå‹•å®Ÿè¡Œ | âœ… æ™‚ç³»åˆ—ç”Ÿãƒ‡ãƒ¼ã‚¿â†’æ°¸ç¶šä¿å­˜ |
| ä¾¡æ ¼å±¥æ­´APIå¿œç­” | é«˜é€Ÿ | âœ… é›†è¨ˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ |

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ä¸»è¦å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«
- `apps/functions/src/endpoints/dlsite-individual-info-api.ts` - çµ±åˆãƒ‡ãƒ¼ã‚¿åé›†Function
- `apps/functions/src/services/dlsite/timeseries-firestore.ts` - æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿å‡¦ç†åŸºç›¤
- `apps/functions/src/services/dlsite/work-id-validator.ts` - å’Œé›†åˆIDåé›†ãƒ»ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°æ¤œå‡º
- `apps/functions/src/services/dlsite/individual-info-to-work-mapper.ts` - ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯
- `apps/web/src/app/api/timeseries/[workId]/route.ts` - ä¾¡æ ¼å±¥æ­´ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ¨ç§»API

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [FIRESTORE_STRUCTURE.md](./FIRESTORE_STRUCTURE.md) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ è©³ç´°
- [DEVELOPMENT.md](./DEVELOPMENT.md) - é–‹ç™ºç’°å¢ƒãƒ»è¨­è¨ˆåŸå‰‡
- [INFRASTRUCTURE_ARCHITECTURE.md](./INFRASTRUCTURE_ARCHITECTURE.md) - ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆ
- [DEPLOYMENT_GUIDE.md](./DEPLOYMENT_GUIDE.md) - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»é‹ç”¨ã‚¬ã‚¤ãƒ‰

---

## ğŸ“‹ å®Ÿè£…ç·æ‹¬

### æŠ€è¡“çš„é©æ–°
- âœ… Individual Info APIé‡è¤‡å‘¼ã³å‡ºã—å®Œå…¨æ’é™¤
- âœ… 1ã¤ã®Cloud Functionã§åŸºæœ¬ãƒ‡ãƒ¼ã‚¿æ›´æ–° + æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿åé›† + æ—¥æ¬¡é›†è¨ˆ
- âœ… ãƒ‡ãƒ¼ã‚¿ä¸€è²«æ€§100%ä¿è¨¼ï¼ˆåŒä¸€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ´»ç”¨ï¼‰
- âœ… ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°å¯¾å¿œã«ã‚ˆã‚‹å®Œå…¨ãƒ‡ãƒ¼ã‚¿åé›†

### ã‚·ã‚¹ãƒ†ãƒ åŠ¹ç‡å‘ä¸Š
- âœ… APIå‘¼ã³å‡ºã—é‡è¤‡: 100%æ’é™¤
- âœ… Functionå®Ÿè¡Œå›æ•°: 67%å‰Šæ¸›
- âœ… ãƒ‡ãƒ¼ã‚¿æ›´æ–°é »åº¦: æ¯æ™‚1å›ã®å…¨ä½œå“ä¿è¨¼
- âœ… é•·æœŸãƒ‡ãƒ¼ã‚¿åˆ†æ: æ—¥æ¬¡é›†è¨ˆã«ã‚ˆã‚‹æ°¸ç¶šä¿å­˜

### é‹ç”¨åŠ¹ç‡åŒ–
- âœ… ç®¡ç†å¯¾è±¡Function: ç°¡ç´ åŒ–é”æˆ
- âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä¸€æœ¬åŒ–: æ¯æ™‚0åˆ†å®Ÿè¡Œ
- âœ… ç›£è¦–ãƒ»ãƒ­ã‚°: çµ±åˆFunctionä¸­å¿ƒã®ä¸€å…ƒç®¡ç†
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: å …ç‰¢ãªä¾‹å¤–å‡¦ç†

---

**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 10.1 (çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ + ãƒªãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°å¯¾å¿œ + æ—¥æ¬¡é›†è¨ˆå®Ÿè£…)  
**å®Ÿè£…å®Œäº†æ—¥**: 2025-07-09  
**æœ€çµ‚æ›´æ–°**: 2025-07-09  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **çµ±åˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ + å’Œé›†åˆã‚¢ã‚¯ã‚»ã‚¹ + æ™‚ç³»åˆ—æ—¥æ¬¡é›†è¨ˆå®Ÿè£…å®Œäº†**

### v10.1è¿½åŠ æ©Ÿèƒ½ï¼ˆ2025å¹´7æœˆ9æ—¥ï¼‰
- âœ… **æ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿æ—¥æ¬¡é›†è¨ˆ**: ç”Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ°¸ç¶šä¿å­˜å¯èƒ½ãªæ—¥æ¬¡é›†è¨ˆãƒ‡ãƒ¼ã‚¿è‡ªå‹•ç”Ÿæˆ
- âœ… **ä¾¡æ ¼å±¥æ­´APIé«˜é€ŸåŒ–**: é›†è¨ˆæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹é«˜é€Ÿãªä¾¡æ ¼æ¨ç§»ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°åˆ†æ
- âœ… **é•·æœŸãƒ‡ãƒ¼ã‚¿åˆ†æ**: 7æ—¥é–“åˆ¶é™ã‚’è¶…ãˆãŸæ°¸ç¶šçš„ãªæ™‚ç³»åˆ—ãƒ‡ãƒ¼ã‚¿ä¿å­˜
- âœ… **è‡ªå‹•é›†è¨ˆå‡¦ç†**: æ™‚ç³»åˆ—ç”Ÿãƒ‡ãƒ¼ã‚¿ä¿å­˜å¾Œã®è‡ªå‹•æ—¥æ¬¡é›†è¨ˆå®Ÿè¡Œ
- âœ… **ãƒ¡ãƒ¢ãƒªåŠ¹ç‡æœ€é©åŒ–**: ãƒãƒƒãƒå‡¦ç†ã«ã‚ˆã‚‹åŠ¹ç‡çš„ãªé›†è¨ˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ