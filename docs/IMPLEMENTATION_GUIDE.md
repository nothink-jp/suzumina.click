# 実装方針ガイド

このドキュメントは、suzumina.click プロジェクトの実装方針と技術仕様をまとめたものです。開発者として参照すべき主要な情報を体系的に整理しています。

## 目次

1. [基本設計原則](#1-基本設計原則)
2. [技術スタック](#2-技術スタック)
3. [アーキテクチャ](#3-アーキテクチャ)
4. [コンポーネント設計](#4-コンポーネント設計)
5. [データモデル](#5-データモデル)
6. [スタイリング方針](#6-スタイリング方針)
7. [認証システム](#7-認証システム)
8. [インフラストラクチャ](#8-インフラストラクチャ)
9. [開発プロセス](#9-開発プロセス)
10. [デプロイフロー](#10-デプロイフロー)
11. [テスト方針](#11-テスト方針)
12. [主要機能の実装ステータス](#12-主要機能の実装ステータス)

## 1. 基本設計原則

### 1.1 サーバーコンポーネント (RSC) ファースト

- Next.js App Router の機能を最大限活用し、デフォルトでサーバーコンポーネントを使用
- `page.tsx` および `layout.tsx` は原則としてサーバーコンポーネント
- データフェッチや処理はサーバーコンポーネントで実行

### 1.2 クライアントコンポーネント (RCC) の適切な利用

- インタラクティビティ（`useState`, `useEffect` など）やブラウザAPIへのアクセス、クライアントサイド前提のライブラリが必要な場合に限り、クライアントコンポーネント (`"use client"` ディレクティブを使用) を導入
- **インサイドアウト・アプローチ**: クライアントコンポーネントは可能な限り小さく、ページの末端（リーフ）に近い部分で利用

### 1.3 コロケーション

- 特定のページに強く関連づくコンポーネントは、そのページのディレクトリ配下に `_components` ディレクトリを作成し、そこに配置
- 再利用性の高い共通コンポーネントは `apps/web/src/components` ディレクトリに配置

### 1.4 Server Actions優先

- API Routesは可能な限り使用せず、Server Actionsを使用してサーバーサイドロジックを実装
- フォーム処理、データ更新、認証チェックなどはServer Actionsによる実装を基本とする

### 1.5 コード品質

- 純粋関数、短い関数、単一責務の原則 (SRP) を意識
- 可読性、保守性、テスト容易性を重視
- コードの重複を避け、シンプルな設計を目指す

## 2. 技術スタック

### 2.1 フロントエンド

- **Next.js**: App Routerを採用したReactフレームワーク
- **React**: UIコンポーネントライブラリ
- **TypeScript**: 型安全な開発環境
- **Tailwind CSS**: ユーティリティファーストのCSSフレームワーク

### 2.2 バックエンド

- **Next.js Server Components**: サーバーサイドレンダリング
- **Server Actions**: サーバーサイドロジック実装
- **Firebase Admin SDK**: サーバーサイドでのFirebase操作

### 2.3 データベース

- **Firestore**: NoSQLデータベース
- **Firebase Storage**: メディアファイル保存

### 2.4 認証

- **Firebase Authentication**: ユーザー認証基盤
- **Discord OAuth**: ソーシャルログイン

### 2.5 インフラストラクチャ

- **Google Cloud Run**: コンテナ化されたアプリケーションのホスティング
- **Cloud Functions**: サーバーレス関数
- **Terraform**: インフラストラクチャのコード化（IaC）

### 2.6 開発ツール

- **pnpm**: パッケージマネージャー
- **Biome**: リンター・フォーマッター
- **Vitest**: テストフレームワーク
- **Lefthook**: Gitフック管理
- **Skaffold**: ローカル開発環境の自動化

## 3. アーキテクチャ

### 3.1 モノレポ構成

- **apps/web**: Next.jsウェブアプリケーション
- **apps/functions**: Firebase Cloud Functions
- **packages/shared-types**: 共有型定義

### 3.2 ディレクトリ構造（Web）

```
apps/web/
├── src/
│   ├── actions/        # Server Actions
│   ├── app/            # Next.js App Router
│   ├── components/     # 共通コンポーネント
│   ├── hooks/          # カスタムフック
│   ├── lib/            # ドメイン別ライブラリ
│   ├── mocks/          # テスト用モック
│   └── utils/          # ユーティリティ関数
```

### 3.3 データフロー

1. **サーバーコンポーネント**: データフェッチ・初期表示
2. **Server Actions**: データ更新・処理
3. **クライアントコンポーネント**: ユーザーインタラクション

### 3.4 状態管理

- サーバーコンポーネントとServer Actionsを活用し、クライアントサイドの状態管理を最小限に抑制
- 必要に応じて `useState` や `useReducer` を使用（クライアントコンポーネント内）
- グローバル状態は最小限に留め、必要な場合のみContext APIを使用

### 3.5 エラーハンドリング

- サーバーコンポーネント: try-catchパターン
- Server Actions: 構造化されたレスポンスオブジェクト
- クライアントコンポーネント: エラーバウンダリー

## 4. コンポーネント設計

### 4.1 コンポーネント分類

- **ページコンポーネント**: `app` ディレクトリ内の `page.tsx` ファイル
- **レイアウトコンポーネント**: `app` ディレクトリ内の `layout.tsx` ファイル
- **UIコンポーネント**: 再利用可能な汎用コンポーネント（`components/ui/`）
- **機能コンポーネント**: 特定の機能に紐づくコンポーネント（`components/videos/`など）
- **ページ固有コンポーネント**: 特定のページでのみ使用（`app/videos/_components/`など）

### 4.2 コンポーネント命名規則

- **パスカルケース**: すべてのコンポーネントファイル（例: `VideoList.tsx`）
- **説明的な名前**: 機能や目的を明確に表す名前
- **接尾辞の活用**:
  - `*Form.tsx`: フォームコンポーネント
  - `*Provider.tsx`: コンテキストプロバイダー

### 4.3 コンポーネント設計原則

- **単一責務**: 各コンポーネントは明確な単一の責務を持つ
- **コンポジション**: 小さなコンポーネントを組み合わせて複雑なUIを構築
- **プロップドリリング回避**: 必要に応じてコンテキストを活用
- **適切な粒度**: 再利用性と可読性のバランスを考慮

### 4.4 テスト容易性

- **依存性の注入**: 外部依存はプロップスとして渡す
- **関心の分離**: ロジックとUIの分離
- **テスト可能なインターフェース**: 明確なプロップス定義

## 5. データモデル

### 5.1 主要エンティティ

- **User**: ユーザー情報
- **Video**: YouTube動画情報
- **AudioClip**: 音声クリップ情報
- **Tag**: タグ情報

### 5.2 Firestoreコレクション構造

```
/users/{userId}
/videos/{videoId}
/audioclips/{clipId}
/tags/{tagId}
/userFavorites/{userId}/clips/{clipId}
/userTags/{userId}/tags/{tagId}
```

### 5.3 型定義

- `packages/shared-types` で一元管理
- Firestore用のデータコンバーターと連携

### 5.4 データバリデーション

- Zod スキーマによるバリデーション
- Server Actions内での入力検証
- Firestore Security Rulesによるデータアクセス制御

## 6. スタイリング方針

### 6.1 Tailwind CSS

- ユーティリティファーストアプローチ
- カスタムテーマ設定（`tailwind.config.js`）
- レスポンシブデザイン対応

### 6.2 コンポーネントスタイリング

- インラインスタイリング優先
- 複雑なスタイルは抽出して再利用（`@apply` ディレクティブ）
- 命名規則: BEM（Block Element Modifier）の考え方を参考

### 6.3 ダークモード対応

- Tailwindの `dark:` バリアントを活用
- システム設定に基づく自動切り替え

### 6.4 アクセシビリティ

- 適切なコントラスト比
- キーボードナビゲーション対応
- スクリーンリーダー対応

## 7. 認証システム

### 7.1 認証フロー

- Firebase Authentication をバックエンドとして使用
- Discord OAuth による認証
- セッションCookieによるサーバーサイド認証状態管理

### 7.2 認証コンポーネント

- `AuthProvider`: クライアントサイド認証状態管理
- `AuthModal`: ログインモーダル
- Server Actionsによる認証処理

### 7.3 認証状態の取得

- サーバーコンポーネント: `getCurrentUser()` Server Action
- クライアントコンポーネント: `useAuth()` フック

### 7.4 保護されたルート

- サーバーコンポーネントでの認証チェック
- 未認証ユーザーのリダイレクト処理

## 8. インフラストラクチャ

### 8.1 Google Cloud Platform

- **Cloud Run**: Webアプリケーションのホスティング
- **Cloud Functions**: バックグラウンド処理、定期実行タスク
- **Firestore**: データベース
- **Cloud Storage**: 静的ファイル、メディアストレージ
- **Artifact Registry**: Dockerイメージ管理
- **Cloud Scheduler**: 定期実行ジョブ
- **Pub/Sub**: 非同期メッセージング

### 8.2 Firebase

- **Authentication**: ユーザー認証
- **Firestore**: NoSQLデータベース
- **Storage**: ファイルストレージ
- **Security Rules**: データアクセス制御

### 8.3 Terraform管理

- インフラストラクチャのコード化（IaC）
- 環境ごとの構成管理
- CI/CDパイプラインとの連携

### 8.4 監視とロギング

- Cloud Monitoringによる監視
- Cloud Loggingによるログ管理
- アラート設定

## 9. 開発プロセス

### 9.1 ドキュメント管理

- `docs/TODO.md`: タスク管理（チェックリスト形式）
- `docs/CHANGELOG.md`: 変更履歴管理
- `docs/POLICY.md`: 実装ポリシー
- リリースノート: GitHub Releasesで自動生成

### 9.2 開発プラクティス

- **テスト手法**: Red-Green-Refactorサイクル + Arrange-Act-Assertパターン
- **カバレッジ目標**: 最低80%
- **コード品質基準**:
  - 純粋関数優先
  - 短い関数
  - 単一責務の原則
- **設計原則**:
  - コードコロケーション（関連コードの近接配置）
  - 可読性優先
  - 保守性
  - テスト容易性
  - 重複回避
  - シンプルな設計

### 9.3 開発ワークフロー

- **実装後チェックリスト**:
  - テスト実行
  - コードフォーマット
  - リント
  - ビルド確認
  - 問題の即時修正

### 9.4 バージョン管理

- **コミット規約**: Conventional Commits
  - feat: 新機能
  - fix: バグ修正
  - docs: ドキュメント
  - style: フォーマット
  - refactor: リファクタリング
  - test: テスト
  - chore: 雑務
- **開発フロー**:
  - トランクベース開発
  - GitHub Flow

## 10. デプロイフロー

### 10.1 CI/CDパイプライン

- GitHub Actionsによる自動化
- プルリクエストごとの検証
- メインブランチへのマージ時に自動デプロイ

### 10.2 環境

- **開発環境**: ローカル開発環境
- **ステージング環境**: プルリクエスト検証用
- **本番環境**: ユーザー向けサービス

### 10.3 デプロイプロセス

1. コードのビルドと検証
2. Dockerイメージの作成
3. Artifact Registryへのプッシュ
4. Terraformによるインフラ更新
5. Cloud Runサービスの更新
6. Cloud Functionsのデプロイ

### 10.4 ロールバック戦略

- 問題発生時の自動ロールバック
- 手動ロールバックの手順

## 11. テスト方針

### 11.1 テスト種類

- **単体テスト**: 個々の関数やコンポーネントの検証
- **統合テスト**: 複数のコンポーネントやモジュールの連携検証
- **E2Eテスト**: ユーザーフローの検証

### 11.2 テストツール

- **Vitest**: 単体テスト・統合テスト
- **React Testing Library**: コンポーネントテスト
- **MSW (Mock Service Worker)**: APIモック

### 11.3 テスト戦略

- **TDD (Test-Driven Development)**: テストファースト開発
- **コンポーネントテスト**: ユーザー操作シミュレーション
- **スナップショットテスト**: UI変更の検出
- **カバレッジ目標**: 80%以上

### 11.4 テスト命名規則

- テストファイル: `*.test.ts` または `*.test.tsx`
- テスト関数: `it('should do something', () => {...})`

## 12. 主要機能の実装ステータス

### 12.1 完了した機能

- Discord認証システム
- YouTube動画一覧表示
- 動画詳細ページ
- ユーザープロフィール管理
- 音声クリップのタグ付け
- お気に入り機能

### 12.2 進行中の機能

- 音声クリップの共有機能
- 高度な検索機能
- ユーザーダッシュボード

### 12.3 計画中の機能

- コメント機能
- 通知システム
- モバイルアプリ対応

### 12.4 優先度の高い技術的負債

- パフォーマンス最適化
- エラーハンドリングの強化
- アクセシビリティ対応の拡充
