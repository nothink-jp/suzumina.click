# CI/CD パイプライン

このドキュメントでは、プロジェクトのCI/CDパイプラインの概要と使用方法について説明します。

## CI/CDパイプラインの概要

suzumina.clickプロジェクトでは、GitHub Actionsを使用した自動テスト・ビルド・デプロイのパイプラインを採用しています。2025年5月2日のCI/CD改善により、すべてのビルド・デプロイ処理をGitHub Actionsで一元管理するようになりました。

CI/CDパイプラインは以下の3つの主要なワークフローで構成されています：

1. **CI（継続的インテグレーション）** - すべてのコードの検証とテスト
2. **変更検知による自動デプロイ** - 特定のディレクトリに変更があった場合のみデプロイ
3. **本番環境デプロイ** - 手動トリガーまたはCI成功後の総合的なデプロイ

## モノレポ構造とワークフロー設計

本プロジェクトはモノレポ構造（`apps/web`と`apps/functions`）を採用しており、ワークフローはこの構造に最適化されています：

- 共通のリポジトリ全体の検証（Biomeによるコード検証）
- Webアプリケーション（Next.js）固有の検証とデプロイ
- Cloud Functions固有の検証とデプロイ

この構造により、変更があった部分のみを効率的に検証・デプロイすることが可能になっています。

## 各ワークフローの役割と使用方法

### 1. CI ワークフロー （ci.yml）

**目的**: コードの品質保証と基本的な検証

**トリガー**:
- mainブランチへのプッシュ
- mainブランチへのプルリクエスト

**ジョブ**:
1. **共通コード検証**: リポジトリ全体のBiomeによるコード検証
2. **Webアプリケーション検証**: `apps/web`のテストとビルド
3. **Cloud Functions検証**: `apps/functions`のテストとビルド

CIワークフローはコードの変更がある度に自動的に実行され、問題がないことを確認します。明示的に実行する必要はありません。

### 2. 変更検知による自動デプロイ （auto-deploy.yml）

**目的**: 効率的な継続的デプロイ

**トリガー**:
- mainブランチへのプッシュ（`apps/web/**`または`apps/functions/**`に変更がある場合のみ）

**主な機能**:
- パスフィルターによる変更検出
- 変更されたコンポーネントのみをデプロイ
- Cloud Functionsは変更された関数のみをデプロイ

**デプロイフロー**:
1. **変更検出**: アプリケーションコードの変更を検出
2. **Workload Identity Federation認証**: GCPへの安全な認証
3. **変更されたコンポーネントのデプロイ**: 
   - `apps/web`の変更: Cloud Runへデプロイ
   - `apps/functions`の変更: Cloud Functionsへデプロイ

このワークフローは、変更を検出した場合に自動的に実行され、関連するコンポーネントのみをデプロイします。明示的に実行する必要はありません。

### 3. 本番環境デプロイ （deploy-production.yml）

**目的**: 完全なプロダクション環境デプロイ

**トリガー**:
- 手動実行（GitHub Actionsインターフェースから）
- CIワークフロー成功後（mainブランチのみ、オプション）

**ジョブ**:
1. **デプロイ条件の確認**: デプロイ前の条件チェック
2. **Webアプリケーションデプロイ**: Cloud Runへのデプロイ
   - モノレポ依存関係インストール
   - Next.jsアプリケーションビルド
   - Dockerイメージ作成とContainer Registryへのプッシュ
   - Cloud Runサービス更新
3. **Cloud Functionsデプロイ**: すべての関数のデプロイ
   - モノレポ依存関係インストール
   - Cloud Functionsのビルドとデプロイ
4. **デプロイ完了通知**: デプロイ成功の通知

このワークフローは手動で実行することも、CI成功後に自動的に実行することもできます。特定のブランチからデプロイしたい場合は、手動トリガーを使用してブランチを指定します。

## デプロイの最小権限設計

セキュリティ強化のため、デプロイ用のサービスアカウントは最小権限原則に基づいて構成されています：

1. **cloud-run-deployer-sa**: Cloud Runサービスのデプロイのみに必要な権限を持つ
   - `roles/run.admin` - Cloud Runサービスの管理
   - `roles/artifactregistry.writer` - コンテナイメージのアップロード
   - `roles/logging.logWriter` - ログの書き込み
   - `roles/iam.serviceAccountUser` - サービスアカウントの利用

2. **cloud-functions-deployer-sa**: Cloud Functionsのデプロイのみに必要な権限を持つ
   - `roles/cloudfunctions.developer` - Cloud Functionsの管理
   - `roles/storage.objectAdmin` - ソースコードアップロード用
   - `roles/logging.logWriter` - ログの書き込み
   - `roles/iam.serviceAccountUser` - サービスアカウントの利用

これにより、万が一GitHubのシークレットが漏洩した場合でも、被害を最小限に抑えることができます。

## Cloud Build廃止とGitHub Actions統合

2025年5月2日のCI/CD改善により、以前使用していたCloud Buildを廃止し、すべてのビルドとデプロイプロセスをGitHub Actionsに統合しました。この変更により以下のメリットが得られました：

1. **シンプルなアーキテクチャ**
   - 単一のCI/CDシステムでビルドからデプロイまで一貫して管理
   - トラブルシューティングが容易に

2. **コスト最適化**
   - Cloud Build関連のリソースとコストを削減
   - 重複するインフラの最小化

3. **管理の簡素化**
   - `cloudbuild.yaml`の代わりにGitHub Workflowsのみでの管理
   - 履歴やログの一元的な管理

## デプロイ履歴と確認

各デプロイの結果はGitHub Actionsの実行履歴で確認できます。デプロイされたURLはワークフローの出力に表示されます。

デプロイの詳細なログが必要な場合は、GitHub Actionsの実行結果またはGoogle Cloud Consoleで確認できます：

- GitHub Actionsログ: `Actions` タブ → ワークフローの実行 → ジョブ → ステップ
- Google Cloud Console: Cloud Run または Cloud Functions のサービス履歴

## デプロイエラーのトラブルシューティング

デプロイが失敗した場合は、以下の点を確認してください：

1. **ビルドエラー**: ビルドステップのログを確認
2. **認証エラー**: サービスアカウントの権限設定を確認
3. **リソースエラー**: Google Cloudのリソース制限やクォータを確認
4. **環境変数エラー**: 必要な環境変数やシークレットが設定されているか確認

それでも問題が解決しない場合は、CI/CD担当者に連絡してください。

## 今後の改善計画

CI/CDパイプラインは継続的に改善される予定です。今後計画されている改善点：

1. **ビルドキャッシュの最適化**: ビルド時間のさらなる短縮
2. **テストカバレッジレポート**: テストカバレッジの自動計測と報告
3. **パフォーマンスモニタリング**: デプロイ後のパフォーマンス自動測定
4. **E2Eテスト**: エンドツーエンドテストの追加

詳細な作業項目は[TODO.md](TODO.md)を参照してください。

---

最終更新: 2025年5月2日