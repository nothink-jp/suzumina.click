# Deployment Optimization Guide

## ğŸš€ Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤é«˜é€ŸåŒ–å®Ÿè£…å®Œäº†

### ğŸ“Š æœ€é©åŒ–å‰å¾Œã®æ¯”è¼ƒ

#### â±ï¸ æ¨å®šå®Ÿè¡Œæ™‚é–“
- **æœ€é©åŒ–å‰**: 3åˆ† (180ç§’)
- **æœ€é©åŒ–å¾Œ**: 1-1.5åˆ† (60-90ç§’)  
- **å‰Šæ¸›ç‡**: 50-67%ã®é«˜é€ŸåŒ–

### ğŸ¯ å®Ÿè£…ã—ãŸæœ€é©åŒ–

#### 1. Docker ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
```dockerfile
# ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã® cache mount
RUN --mount=type=cache,target=/pnpm,sharing=locked \
    pnpm install --frozen-lockfile

RUN --mount=type=cache,target=/app/apps/web/.next/cache \
    --mount=type=cache,target=/app/apps/web/node_modules/.cache \
    pnpm build
```

**åŠ¹æœ**: 
- pnpm install: 30-60ç§’ â†’ 5-15ç§’
- Next.js build: 60-90ç§’ â†’ 20-40ç§’

#### 2. Docker Buildx ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥
```bash
docker buildx build \
  --cache-from type=registry,ref=$CACHE_TAG \
  --cache-to type=registry,ref=$CACHE_TAG,mode=max \
  --push
```

**åŠ¹æœ**:
- Docker layerå†åˆ©ç”¨ã«ã‚ˆã‚‹å¤§å¹…é«˜é€ŸåŒ–
- CIç’°å¢ƒé–“ã§ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å…±æœ‰

#### 3. GitHub Actions ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
```yaml
# Next.js build cache
- name: Cache Next.js build
  uses: actions/cache@v4
  with:
    path: apps/web/.next/cache
    key: ${{ runner.os }}-nextjs-${{ hashFiles(...) }}

# pnpm store cache (æ”¹è‰¯)
- name: Setup pnpm cache
  uses: actions/cache@v4
  with:
    path: ${{ env.STORE_PATH }}
    key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
```

**åŠ¹æœ**:
- Next.js ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ãƒšãƒ¼ã‚¸å·®åˆ†ã®ã¿ãƒ“ãƒ«ãƒ‰
- pnpm: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é«˜é€ŸåŒ–

#### 4. ä¸¦åˆ—å‡¦ç†æœ€é©åŒ–
```bash
# å“è³ªãƒã‚§ãƒƒã‚¯ä¸¦åˆ—å®Ÿè¡Œ
pnpm --filter web test &
pnpm --filter web lint &  
pnpm --filter web typecheck &
wait # å…¨ã¦å®Œäº†ã¾ã§å¾…æ©Ÿ
```

**åŠ¹æœ**:
- å“è³ªãƒã‚§ãƒƒã‚¯: 90ç§’ â†’ 30ç§’ (æœ€é…ãƒ—ãƒ­ã‚»ã‚¹æ™‚é–“)
- CPUä¸¦åˆ—åˆ©ç”¨ã«ã‚ˆã‚‹å¤§å¹…é«˜é€ŸåŒ–

### ğŸ“ˆ è©³ç´°æœ€é©åŒ–å†…å®¹

#### Web App (`deploy-cloud-run.yml`)
1. **Docker Buildx**: ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ + ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
2. **Next.js ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: `.next/cache` æ°¸ç¶šåŒ–
3. **ä¸¦åˆ—å“è³ªãƒã‚§ãƒƒã‚¯**: test/lint/typecheck åŒæ™‚å®Ÿè¡Œ
4. **pnpm æœ€é©åŒ–**: ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ + ã‚¹ãƒˆã‚¢æ°¸ç¶šåŒ–

#### Admin App (`deploy-admin.yml`)  
1. **åŒæ§˜ã®Dockeræœ€é©åŒ–**: buildx + ã‚­ãƒ£ãƒƒã‚·ãƒ¥
2. **è»½é‡ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†**: 5ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ»3ãƒªãƒ“ã‚¸ãƒ§ãƒ³ä¿æŒ

#### Dockerfileæœ€é©åŒ–
1. **cache mount**: å…¨ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨
2. **sharing=locked**: ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰æ™‚ã®å®‰å…¨ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥å…±æœ‰
3. **mode=max**: æœ€å¤§é™ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥

### ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹çµæœ

#### åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—)
- **Web App**: 2.5-3åˆ† â†’ 1.5-2åˆ†
- **Admin App**: 2-2.5åˆ† â†’ 1-1.5åˆ†

#### 2å›ç›®ä»¥é™ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š)
- **Web App**: 1.5-2åˆ† â†’ 45-75ç§’  
- **Admin App**: 1-1.5åˆ† â†’ 30-60ç§’

#### å°è¦æ¨¡å¤‰æ›´æ™‚ (ã‚³ãƒ¼ãƒ‰å¾®ä¿®æ­£)
- **Web App**: 60-90ç§’ â†’ 30-45ç§’
- **Admin App**: 45-60ç§’ â†’ 20-30ç§’

### ğŸ’¡ è¿½åŠ æœ€é©åŒ–æ¡ˆ (å°†æ¥å®Ÿè£…)

#### GitHub Actionsä¸¦åˆ—åŒ–
```yaml
strategy:
  matrix:
    app: [web, admin]
```

#### æ®µéšçš„ãƒ‡ãƒ—ãƒ­ã‚¤
- Canary ãƒªãƒªãƒ¼ã‚¹
- Blue-Green ãƒ‡ãƒ—ãƒ­ã‚¤

#### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
- SSD backed cache
- Redis ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¤ãƒ¤ãƒ¼

### ğŸ”§ é‹ç”¨ãƒã‚¤ãƒ³ãƒˆ

#### åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ç¢ºèªäº‹é …
1. Docker registry ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‹
2. GitHub Actions cache ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹  
3. ãƒ“ãƒ«ãƒ‰æ™‚é–“ãŒæœŸå¾…å€¤å†…ã«åã¾ã£ã¦ã„ã‚‹ã‹

#### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç ´ææ™‚: `docker system prune -a` ã§ãƒªã‚»ãƒƒãƒˆ
- ä¾å­˜é–¢ä¿‚å¤‰æ›´æ™‚: pnpm-lock.yaml ãƒãƒƒã‚·ãƒ¥å¤‰æ›´ã§è‡ªå‹•ç„¡åŠ¹åŒ–
- GitHub Actions cache åˆ¶é™: 10GBåˆ¶é™ã«æ³¨æ„

### ğŸ“Š é‹ç”¨åŠ¹æœæ¸¬å®š

#### ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“ (åˆ†)
- GitHub Actionsä½¿ç”¨æ™‚é–“ (åˆ†)
- Docker registry ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ (GB)
- é–‹ç™ºè€…ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ™‚é–“ (åˆ†)

#### ç›®æ¨™å€¤
- å¹³å‡ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“: 90ç§’ä»¥ä¸‹
- GitHub Actionsæ™‚é–“: æœˆé–“ä½¿ç”¨é‡20%å‰Šæ¸›
- é–‹ç™ºè€…ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯: 2åˆ†ä»¥å†…

---

*suzumina.click Deployment Optimization v1.0 - 2025å¹´7æœˆå®Ÿè£…*