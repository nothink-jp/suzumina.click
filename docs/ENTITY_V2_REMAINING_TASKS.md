# Entity V2 移行 - 残タスク一覧

## 現在の状況（2025-07-25）

### ✅ 完了済み
1. **Phase 1-6**: Entity/Value Object実装完了
2. **Phase 7 - PR #18**: フィーチャーフラグ実装完了
3. **Phase 7 - PR #19**: 本番データ移行完了
   - すべてのVideos/AudioButtonsに`_v2Migration`フラグ付与済み
   - バックアップ作成済み

### ❌ 未実装タスク

## 1. PR #20: Entity V2実使用開始（フィーチャーフラグ統合）
**優先度**: 🔴 高
**推定工数**: 2-3日
**リスク**: 中

### 必要な作業
1. **Server Actions V2の作成**
   ```
   apps/web/src/app/buttons/actions-v2.ts
   apps/web/src/app/videos/actions-v2.ts
   ```
   - Entity V2を使用したServer Actions実装
   - 既存のactions.tsからの移植

2. **フィーチャーフラグによる切り替え実装**
   - `apps/web/src/app/actions.ts`の更新
   - 環境変数からフィーチャーフラグを読み込み
   - V1/V2の動的切り替え

3. **コンポーネントの更新**
   - AudioButtonコンポーネントでV1/V2切り替え
   - VideoコンポーネントでV1/V2切り替え
   - アダプターパターンの活用

4. **テスト**
   - フィーチャーフラグON/OFFでの動作確認
   - パフォーマンステスト

### 現在の問題
- `actions-v2.ts`ファイルが存在しない
- フィーチャーフラグの読み込みは実装済みだが、切り替えロジックが未実装

---

## 2. PR #21: Cloud Functions Entity V2対応
**優先度**: 🟡 中
**推定工数**: 2日
**リスク**: 中

### 必要な作業
1. **YouTube Sync機能のV2対応**
   - `youtube-firestore-v2.ts`の作成
   - 新規動画データをEntity V2形式で保存
   - `_v2Migration`フラグの自動付与

2. **フィーチャーフラグ対応**
   - Cloud Functions側でもフィーチャーフラグを参照
   - V1/V2の保存形式切り替え

3. **後方互換性の維持**
   - 既存データとの整合性確保
   - 段階的移行のサポート

### 注意点
- 新規動画データが現在`_v2Migration`フラグなしで保存されている
- 定期的な移行スクリプト実行が必要

---

## 3. PR #22: 旧コード非推奨化
**優先度**: 🟢 低
**推定工数**: 1日
**リスク**: 低
**実施時期**: PR #21完了 + 2週間後

### 必要な作業
1. **@deprecatedアノテーション追加**
   - 旧Entity定義
   - 旧Mapper
   - V1 Server Actions

2. **Biome設定更新**
   - 非推奨警告の有効化
   - 段階的な警告レベル設定

3. **ドキュメント更新**
   - 移行ガイドの作成
   - 非推奨スケジュールの明示

---

## 4. PR #23: 旧コード削除
**優先度**: 🟢 低
**推定工数**: 2日
**リスク**: 高
**実施時期**: 1ヶ月の安定稼働後

### 必要な作業
1. **削除対象**
   - 旧Entity定義（約1000行）
   - 旧Mapper（約800行）
   - 移行ヘルパー（約500行）
   - V1 Server Actions（約600行）
   - レガシーコンポーネント（約400行）

2. **影響調査**
   - 依存関係の確認
   - テストカバレッジの確認

3. **段階的削除**
   - まず内部APIから削除
   - 次にコンポーネント
   - 最後にEntity定義

---

## 5. PR #24: V2サフィックス削除と環境変数削除
**優先度**: 🟢 低
**推定工数**: 3日
**リスク**: 高
**実施時期**: PR #23完了後

### 必要な作業
1. **リネーム対象**
   - `VideoV2` → `Video`
   - `AudioButtonV2` → `AudioButton`
   - すべてのV2サフィックス付きファイル/関数

2. **環境変数の削除**
   - `ENABLE_ENTITY_V2`環境変数を削除
   - フィーチャーフラグ関連コードを削除
   - 常にEntity V2を使用するように修正

3. **全体的な影響**
   - 全コードベースの更新が必要
   - importパスの変更
   - 型定義の更新
   - 設定ファイルの簡素化

---

## 推奨実施順序

### Phase 1（即座に実施）
1. **PR #20の実装開始**
   - 最優先事項
   - ローカル環境での動作確認が可能
   - ユーザー影響を最小限に抑えた段階的移行

### Phase 2（1週間後）
2. **PR #21の実装**
   - Cloud Functions側の対応
   - 新規データの整合性確保

### Phase 3（2-3週間後）
3. **PR #22の実装**
   - 非推奨化の開始
   - 開発者への周知

### Phase 4（1-2ヶ月後）
4. **PR #23の実装**
   - 旧コードの削除
   - コードベースのクリーンアップ

### Phase 5（3ヶ月後）
5. **PR #24の実装**
   - 最終的な命名規則統一
   - Entity V2移行の完了

---

## リスク管理

### 主なリスク
1. **パフォーマンス劣化**
   - Entity V2の変換オーバーヘッド
   - 対策: パフォーマンステストの実施

2. **データ不整合**
   - V1/V2混在期間中の問題
   - 対策: 十分なテスト期間の確保

3. **ロールバック困難**
   - 一度V2に移行後の後戻り
   - 対策: フィーチャーフラグによる制御

### 成功指標
- エラー率5%未満
- パフォーマンス劣化10%未満
- ユーザークレーム0件

---

最終更新: 2025-07-25