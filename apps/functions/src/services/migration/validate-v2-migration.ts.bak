/**
 * Entity V2 Migration Validation Service
 * 
 * ç§»è¡Œå¾Œã®ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚’è¡Œã†ã‚µãƒ¼ãƒ“ã‚¹
 * çµ±è¨ˆæƒ…å ±ã®ç¢ºèªã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã€ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å¤‰æ›ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½
 */

import type { AudioButtonV2, VideoV2 } from "@suzumina.click/shared-types";
import { getFirestoreInstance } from "../../infrastructure/firestore";

interface ValidationOptions {
	collections: string[];
	sampleSize?: number;
	verbose?: boolean;
}

interface ValidationResult {
	collection: string;
	totalDocuments: number;
	migratedDocuments: number;
	nonMigratedDocuments: number;
	sampleValidations: Array<{
		docId: string;
		valid: boolean;
		error?: string;
	}>;
	statistics: {
		migrationRate: number;
		errorRate: number;
		averageMigrationAge?: number; // ç§»è¡Œã‹ã‚‰ã®çµŒéæ™‚é–“ï¼ˆæ™‚é–“ï¼‰
	};
}

export class V2MigrationValidationService {
	private readonly firestore = getFirestoreInstance();

	constructor(private readonly options: ValidationOptions) {
		this.options.sampleSize = this.options.sampleSize || 10;
	}

	/**
	 * å…¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®æ¤œè¨¼ã‚’å®Ÿè¡Œ
	 */
	async validate(): Promise<{ results: ValidationResult[]; allValid: boolean }> {
		console.log("ğŸ” Entity V2ç§»è¡Œã®æ¤œè¨¼ã‚’é–‹å§‹ã—ã¾ã™...");
		const results: ValidationResult[] = [];
		let allValid = true;

		for (const collection of this.options.collections) {
			const result = await this.validateCollection(collection);
			results.push(result);

			if (result.statistics.errorRate > 0) {
				allValid = false;
			}
		}

		// ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
		await this.generateValidationReport(results);

		return { results, allValid };
	}

	/**
	 * å€‹åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®æ¤œè¨¼
	 */
	private async validateCollection(collectionName: string): Promise<ValidationResult> {
		console.log(`\nğŸ“‚ ${collectionName} ã®æ¤œè¨¼ã‚’é–‹å§‹...`);

		const collection = this.firestore.collection(collectionName);
		
		// çµ±è¨ˆæƒ…å ±ã®åé›†
		const totalSnapshot = await collection.count().get();
		const totalDocuments = totalSnapshot.data().count;

		const migratedSnapshot = await collection
			.where("_v2Migration", "!=", null)
			.count()
			.get();
		const migratedDocuments = migratedSnapshot.data().count;

		const nonMigratedDocuments = totalDocuments - migratedDocuments;
		const migrationRate = totalDocuments > 0 
			? (migratedDocuments / totalDocuments) * 100 
			: 0;

		console.log(`ğŸ“Š çµ±è¨ˆæƒ…å ±:`);
		console.log(`   ç·ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°: ${totalDocuments}`);
		console.log(`   ç§»è¡Œæ¸ˆã¿: ${migratedDocuments}`);
		console.log(`   æœªç§»è¡Œ: ${nonMigratedDocuments}`);
		console.log(`   ç§»è¡Œç‡: ${migrationRate.toFixed(2)}%`);

		// ã‚µãƒ³ãƒ—ãƒ«æ¤œè¨¼
		const sampleValidations = await this.validateSamples(collectionName);
		const errorCount = sampleValidations.filter((v) => !v.valid).length;
		const errorRate = sampleValidations.length > 0
			? (errorCount / sampleValidations.length) * 100
			: 0;

		// ç§»è¡Œæ™‚æœŸã®åˆ†æ
		const averageMigrationAge = await this.calculateAverageMigrationAge(collectionName);

		return {
			collection: collectionName,
			totalDocuments,
			migratedDocuments,
			nonMigratedDocuments,
			sampleValidations,
			statistics: {
				migrationRate,
				errorRate,
				averageMigrationAge,
			},
		};
	}

	/**
	 * ã‚µãƒ³ãƒ—ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ¤œè¨¼
	 */
	private async validateSamples(collectionName: string): Promise<ValidationResult["sampleValidations"]> {
		const collection = this.firestore.collection(collectionName);
		const samples = await collection
			.where("_v2Migration", "!=", null)
			.limit(this.options.sampleSize!)
			.get();

		console.log(`\nğŸ”¬ ${samples.size}ä»¶ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’æ¤œè¨¼ä¸­...`);

		const validations: ValidationResult["sampleValidations"] = [];

		for (const doc of samples.docs) {
			const data = doc.data();
			let valid = true;
			let error: string | undefined;

			try {
				// V2ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã¸ã®å¤‰æ›ãƒ†ã‚¹ãƒˆ
				if (collectionName === "videos") {
					const { VideoV2 } = await import("@suzumina.click/shared-types");
					const video = VideoV2.fromLegacyFormat(data);
					
					// è¿½åŠ ã®æ¤œè¨¼
					this.validateVideoEntity(video, data);
				} else if (collectionName === "audioButtons") {
					const { AudioButtonV2 } = await import("@suzumina.click/shared-types");
					const audioButton = AudioButtonV2.fromLegacyFormat(data);
					
					// è¿½åŠ ã®æ¤œè¨¼
					this.validateAudioButtonEntity(audioButton, data);
				}

				// _v2Migrationãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
				if (!data._v2Migration || !data._v2Migration.version) {
					throw new Error("_v2Migrationãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸æ­£ã§ã™");
				}
			} catch (e) {
				valid = false;
				error = e instanceof Error ? e.message : "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼";
			}

			validations.push({
				docId: doc.id,
				valid,
				error,
			});

			if (this.options.verbose) {
				console.log(`  ${valid ? "âœ…" : "âŒ"} ${doc.id} ${error ? `- ${error}` : ""}`);
			}
		}

		const validCount = validations.filter((v) => v.valid).length;
		console.log(`âœ… æ¤œè¨¼å®Œäº†: ${validCount}/${validations.length} ä»¶ãŒæœ‰åŠ¹`);

		return validations;
	}

	/**
	 * Video ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è©³ç´°æ¤œè¨¼
	 */
	private validateVideoEntity(video: VideoV2, originalData: any): void {
		// å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç¢ºèª
		if (!video.id || !video.title || !video.thumbnailUrl) {
			throw new Error("å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ è½ã—ã¦ã„ã¾ã™");
		}

		// ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ç¢ºèª
		if (video.publishedAt.getTime() > Date.now()) {
			throw new Error("å…¬é–‹æ—¥ãŒæœªæ¥ã®æ—¥ä»˜ã«ãªã£ã¦ã„ã¾ã™");
		}

		// çµ±è¨ˆæƒ…å ±ã®å¦¥å½“æ€§
		if (video.statistics.viewCount < 0 || video.statistics.likeCount < 0) {
			throw new Error("çµ±è¨ˆæƒ…å ±ã«è² ã®å€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™");
		}
	}

	/**
	 * AudioButton ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®è©³ç´°æ¤œè¨¼
	 */
	private validateAudioButtonEntity(audioButton: AudioButtonV2, originalData: any): void {
		// å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç¢ºèª
		if (!audioButton.id || !audioButton.title || !audioButton.sourceVideoId) {
			throw new Error("å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ¬ è½ã—ã¦ã„ã¾ã™");
		}

		// æ™‚é–“ç¯„å›²ã®å¦¥å½“æ€§
		if (audioButton.audioContent.startTime >= audioButton.audioContent.endTime) {
			throw new Error("é–‹å§‹æ™‚é–“ãŒçµ‚äº†æ™‚é–“ä»¥é™ã«ãªã£ã¦ã„ã¾ã™");
		}

		// çµ±è¨ˆæƒ…å ±ã®å¦¥å½“æ€§
		if (audioButton.statistics.playCount < 0 || audioButton.statistics.likeCount < 0) {
			throw new Error("çµ±è¨ˆæƒ…å ±ã«è² ã®å€¤ãŒå«ã¾ã‚Œã¦ã„ã¾ã™");
		}
	}

	/**
	 * å¹³å‡ç§»è¡ŒçµŒéæ™‚é–“ã®è¨ˆç®—
	 */
	private async calculateAverageMigrationAge(collectionName: string): Promise<number | undefined> {
		const collection = this.firestore.collection(collectionName);
		const samples = await collection
			.where("_v2Migration", "!=", null)
			.limit(100)
			.get();

		if (samples.empty) return undefined;

		const now = Date.now();
		let totalAge = 0;
		let count = 0;

		for (const doc of samples.docs) {
			const migrationTime = doc.data()._v2Migration?.migratedAt?.toDate();
			if (migrationTime) {
				totalAge += (now - migrationTime.getTime()) / (1000 * 60 * 60); // æ™‚é–“å˜ä½
				count++;
			}
		}

		return count > 0 ? totalAge / count : undefined;
	}

	/**
	 * æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆ
	 */
	private async generateValidationReport(results: ValidationResult[]): Promise<void> {
		const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
		const reportPath = `validation-report-${timestamp}.md`;

		let report = "# Entity V2 Migration Validation Report\n\n";
		report += `Generated at: ${new Date().toISOString()}\n\n`;

		// ã‚µãƒãƒªãƒ¼
		report += "## Summary\n\n";
		const totalDocs = results.reduce((sum, r) => sum + r.totalDocuments, 0);
		const totalMigrated = results.reduce((sum, r) => sum + r.migratedDocuments, 0);
		const overallRate = totalDocs > 0 ? (totalMigrated / totalDocs) * 100 : 0;

		report += `- Total Documents: ${totalDocs}\n`;
		report += `- Migrated Documents: ${totalMigrated}\n`;
		report += `- Overall Migration Rate: ${overallRate.toFixed(2)}%\n\n`;

		// å„ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°
		for (const result of results) {
			report += `## ${result.collection}\n\n`;
			report += `### Statistics\n`;
			report += `- Total: ${result.totalDocuments}\n`;
			report += `- Migrated: ${result.migratedDocuments}\n`;
			report += `- Non-migrated: ${result.nonMigratedDocuments}\n`;
			report += `- Migration Rate: ${result.statistics.migrationRate.toFixed(2)}%\n`;
			report += `- Sample Error Rate: ${result.statistics.errorRate.toFixed(2)}%\n`;
			
			if (result.statistics.averageMigrationAge !== undefined) {
				report += `- Average Migration Age: ${result.statistics.averageMigrationAge.toFixed(1)} hours\n`;
			}

			// ã‚¨ãƒ©ãƒ¼ã®è©³ç´°
			const errors = result.sampleValidations.filter((v) => !v.valid);
			if (errors.length > 0) {
				report += `\n### Validation Errors\n`;
				for (const error of errors) {
					report += `- ${error.docId}: ${error.error}\n`;
				}
			}

			report += "\n";
		}

		// æ¨å¥¨äº‹é …
		report += "## Recommendations\n\n";
		const hasErrors = results.some((r) => r.statistics.errorRate > 0);
		const hasUnmigrated = results.some((r) => r.nonMigratedDocuments > 0);

		if (hasErrors) {
			report += "- âš ï¸ ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„\n";
		}
		if (hasUnmigrated) {
			report += "- âš ï¸ æœªç§»è¡Œã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™ã€‚ç§»è¡Œã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„\n";
		}
		if (!hasErrors && !hasUnmigrated) {
			report += "- âœ… ã™ã¹ã¦ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæ­£å¸¸ã«ç§»è¡Œã•ã‚Œã¦ã„ã¾ã™\n";
		}

		// ãƒ¬ãƒãƒ¼ãƒˆã®ä¿å­˜
		const fs = await import("node:fs/promises");
		await fs.writeFile(reportPath, report);
		console.log(`\nğŸ“„ æ¤œè¨¼ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ: ${reportPath}`);
	}
}

// CLIã¨ã—ã¦å®Ÿè¡Œã™ã‚‹å ´åˆ
if (require.main === module) {
	const args = process.argv.slice(2);
	const verbose = args.includes("--verbose");
	const sampleSize = args.includes("--sample-size")
		? Number.parseInt(args[args.indexOf("--sample-size") + 1], 10)
		: 10;

	const validationService = new V2MigrationValidationService({
		collections: ["videos", "audioButtons"],
		sampleSize,
		verbose,
	});

	validationService
		.validate()
		.then(({ allValid }) => {
			if (allValid) {
				console.log("\nâœ¨ ã™ã¹ã¦ã®æ¤œè¨¼ã«åˆæ ¼ã—ã¾ã—ãŸï¼");
			} else {
				console.error("\nâš ï¸ ä¸€éƒ¨ã®æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
				process.exit(1);
			}
		})
		.catch((error) => {
			console.error("\nğŸ’¥ æ¤œè¨¼ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
			process.exit(1);
		});
}